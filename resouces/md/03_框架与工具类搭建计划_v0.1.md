# 第一阶段：框架与工具类搭建计划（v0.1）

> 目标：在不进入具体业务功能开发前，完成可复用、可扩展、可观测的基础工程骨架。
> 更新时间：2026-02-12（增量同步）

---

## 0. 阶段范围

本阶段只做基础设施，不做业务功能细节：

包含：
- 微服务工程结构搭建
- 注册中心/配置中心打通（Nacos）
- 网关基础能力（路由、鉴权、限流、trace）
- 通用工具类与 Starter 落地
- 最小可运行链路与验收

不包含：
- 博客完整业务
- AI 完整业务
- 资源审核全流程

---

## 1. 阶段目标与验收标准

### 1.1 目标

1. 本地 `docker compose up` 后可启动：MySQL、Redis、Nacos、Gateway、User、Content、Media、AI。
2. 网关可路由到 user/content/media/ai，具备统一鉴权与限流拦截能力。
3. 通用库被至少 2 个业务服务实际引用并生效。
4. OpenAPI 文档可访问，统一异常返回可见。
5. 审计日志链路可记录至少 1 个关键操作。

### 1.2 验收标准

- 健康检查通过：`/actuator/health`
- 鉴权校验通过：未登录访问受保护接口返回 401/403
- 限流校验通过：超过配额返回统一错误
- trace 贯通：日志可通过 `trace_id` 串联
- 单元测试和静态检查全部通过

---

## 2. 交付物清单

1. 多模块 Maven 父工程
2. 服务模块（`gateway-service`, `user-service`, `content-service`, `media-service`, `ai-service`）
3. 公共模块（3 个）
4. `docker-compose` 基础环境
5. Nacos 基础配置模板
6. Phase0 验收文档与启动说明

---

## 3. 模块设计（第一版）

## 3.1 服务模块

- `gateway-service`
  - 路由
  - 统一鉴权
  - 限流过滤器
  - trace 注入

- `user-service`
  - 认证与用户上下文
  - 分组/权限基础查询
  - 偏好保存接口（壳）

- `content-service`
  - 示例资源接口（验证网关+鉴权+异常链路）

- `media-service`
  - 上传策略签发接口（验证 integration 模块）
  - 资源下载签名接口（验证存储抽象）

- `ai-service`
  - 会话与消息接口（验证限流、审计、配额逻辑）

## 3.2 公共模块

- `common-core`
- `common-servlet`
- `common-integration`

---

## 4. 工具类与基础组件（计划 + 当前实现对齐）

### 4.1 `common-core`（所有服务共用的“通用语言层”）

这一层负责把“返回格式、错误模型、基础实体”统一起来，避免每个服务各说各话。

| 文件 | 这个类是干什么的 | 当前状态 |
|---|---|---|
| `libs/common-core/src/main/java/io/github/shizuki/common/core/response/ApiResponse.java` | 统一成功返回体，控制 `code/message/data/timestamp` 结构 | 已实现并使用 |
| `libs/common-core/src/main/java/io/github/shizuki/common/core/response/PageResponse.java` | 统一分页返回结构，减少分页接口重复定义 | 已实现并使用 |
| `libs/common-core/src/main/java/io/github/shizuki/common/core/error/ErrorCode.java` | 全局错误码枚举，统一错误语义 | 已实现并使用 |
| `libs/common-core/src/main/java/io/github/shizuki/common/core/error/BusinessException.java` | 业务异常基类，配合全局异常处理输出统一响应 | 已实现并使用 |
| `libs/common-core/src/main/java/io/github/shizuki/common/core/model/BaseEntity.java` | 基础实体字段抽象，后续实体可继承 | 已实现（待持久化阶段全面使用） |
| `libs/common-core/src/main/java/io/github/shizuki/common/core/time/ClockProvider.java` | 抽象时间来源，便于测试替换时间 | 已实现 |
| `libs/common-core/src/main/java/io/github/shizuki/common/core/time/SystemClockProvider.java` | 默认系统时间实现 | 已实现 |
| `libs/common-core/src/main/java/io/github/shizuki/common/core/resilience/RetrySpec.java` | 重试策略定义（attempt/backoff/jitter/cap） | 已实现并在 ai/oauth 链路使用 |
| `libs/common-core/src/main/java/io/github/shizuki/common/core/resilience/SpringRetryExecutor.java` | 统一重试执行器，替代业务手写 sleep 退避 | 已实现并使用 |

### 4.2 `common-servlet`（Web 层通用能力包）

这一层主要解决“每个服务都要做，但不想每个服务都重复写”的事情：异常、请求链路、权限、审计、限流、安全净化。

| 文件 | 这个类是干什么的 | 当前状态 |
|---|---|---|
| `libs/common-servlet/src/main/java/io/github/shizuki/common/web/exception/GlobalExceptionHandler.java` | 把异常统一翻译成标准 API 错误响应 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/web/filter/TraceIdFilter.java` | 给每个请求补充/透传 `trace_id`，便于链路排查 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/web/filter/RequestIdFilter.java` | 生成请求唯一 ID，辅助日志定位 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/security/filter/LoginUserContextFilter.java` | 从 Header 读取用户信息并放入上下文 | 已实现（网关透传兼容方案） |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/security/context/LoginUserContext.java` | 当前线程用户上下文容器 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/security/model/LoginUser.java` | 登录用户模型（userId、groups、permissions） | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/security/annotation/RequirePermission.java` | 方法/类级权限声明注解 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/security/annotation/RequireGroup.java` | 方法/类级分组声明注解 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/security/aspect/PermissionAspect.java` | 在调用前校验分组/权限（`ADMIN` 默认放行 `@RequirePermission`） | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/security/service/AclChecker.java` | 权限判断接口，便于后续换实现 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/audit/annotation/AuditLog.java` | 标记需要审计的操作 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/audit/aspect/AuditLogAspect.java` | 自动采集审计日志字段并提交 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/audit/service/AuditLogService.java` | 审计日志存储接口 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/audit/service/LoggingAuditLogService.java` | 默认日志输出实现 | 已实现（作为 DB 实现的降级兜底） |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/audit/service/impl/JdbcAuditOutboxServiceImpl.java` | outbox 持久化 + 重试 + PROCESSING 超时回收 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/audit/util/SensitiveMasker.java` | 敏感字段脱敏工具 | 已实现 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/ratelimit/annotation/RateLimit.java` | 限流注解 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/ratelimit/aspect/RateLimitAspect.java` | 限流执行逻辑（Redis 优先，失败时本地降级） | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/ratelimit/support/LocalRateLimiter.java` | 本地窗口限流兜底实现 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/ratelimit/service/QuotaService.java` | 配额服务接口 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/ratelimit/service/InMemoryQuotaService.java` | 配额内存实现 | 已实现（待替换 DB 实现） |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/xss/service/HtmlSanitizerService.java` | HTML 内容净化，降低 XSS 风险 | 已实现并使用 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/xss/util/ExternalLinkRelRewriter.java` | 外链补 `noopener/noreferrer` 等安全属性 | 已实现 |
| `libs/common-servlet/src/main/java/io/github/shizuki/common/web/config/WebMvcConfig.java` | Web 全局配置入口 | 已实现 |

说明：
- 文档中原先写的“Sa-Token 配置类”“Redis Token Bucket”属于目标态描述。
- 当前代码已实现 Sa-Token 登录态闭环（user + gateway），并保留 Header 上下文透传作为服务内兼容机制。

### 4.3 `common-integration`（外部系统接入适配层）

这一层负责“和外部系统打交道”，把第三方差异隔离在公共库里，业务服务只关心业务接口。

| 文件 | 这个类是干什么的 | 当前状态 |
|---|---|---|
| `libs/common-integration/src/main/java/io/github/shizuki/common/storage/client/ObjectStorageClient.java` | 对象存储统一抽象接口 | 已实现并使用 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/storage/client/AliyunOssClient.java` | 阿里云 OSS 适配实现 | 已实现并接入 media-service |
| `libs/common-integration/src/main/java/io/github/shizuki/common/storage/model/StorageObjectMetadata.java` | 文件元数据模型（类型、长度等） | 已实现 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/storage/util/OssKeyBuilder.java` | 统一 OSS key 命名，避免路径混乱 | 已实现 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/storage/util/UploadValidator.java` | 上传校验工具（文件类型/大小等） | 已实现 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/service/OAuthStateService.java` | OAuth state 抽象接口 | 已实现并使用 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/service/RedisOAuthStateService.java` | OAuth state 的 Redis 实现 | 已实现并使用 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/client/GitHubOAuthClient.java` | GitHub OAuth 换 token/拉用户信息客户端 | 已实现并可用 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/config/OAuthProperties.java` | OAuth 配置映射 | 已实现 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/config/OAuthProviderProperties.java` | provider map 配置模型（github/linuxdo） | 已实现并使用 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/config/OAuthAutoConfiguration.java` | OAuth 自动装配入口 | 已实现 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/strategy/OAuthProviderStrategyFactory.java` | OAuth provider 策略工厂 | 已实现并使用 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/strategy/GitHubOAuthProviderStrategy.java` | GitHub provider 策略实现 | 已实现并使用 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/strategy/LinuxDoOAuthProviderStrategy.java` | LinuxDo provider 策略实现 | 已实现并使用 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/model/OAuthIdentity.java` | 提供方统一身份模型 | 已实现并使用 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/model/GitHubTokenResponse.java` | GitHub token 返回模型 | 已实现 |
| `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/model/GitHubUserResponse.java` | GitHub 用户信息模型 | 已实现 |

---

## 4.4 libs 当前待补齐点（与 v0.1 计划差异）

- 鉴权：主链路已接入 Sa-Token，仍需补齐端到端回归测试与路由规则自动校验。
- 限流：当前是 Redis 计数 + 本地兜底，后续可按需升级为更严格的令牌桶实现。
- 审计：已支持数据库落库、检索与 outbox PROCESSING 超时回收；仍未接统一审计平台消费链路（outbox consumer）。
- 存储：`AliyunOssClient` 已落地，后续重点是密钥托管与轮换治理。

---

## 5. 实施步骤（按顺序）

### Step 1：父工程与依赖管理

- 建立 parent `pom.xml`
- 固定依赖版本（Boot、Cloud、Nacos、MyBatis-Plus、Sa-Token）
- 配置统一 plugin（compiler/surefire/spotless/checkstyle）

### Step 2：基础中间件启动

- Compose 拉起 MySQL、Redis、Nacos
- 初始化数据库与用户
- 验证服务可注册到 Nacos

### Step 3：网关可用

- 建立静态路由与 Nacos 动态配置
- 完成鉴权与限流 filter
- 完成 traceId 透传

### Step 4：公共库落地

- 完成 3 个 common 模块
- user/content/media/ai 引入并验证

### Step 5：最小业务链路验收

- user 提供 `GET /api/v1/me`（返回真实登录态上下文）
- content 提供 `GET /api/v1/posts`（返回 DB 分页数据）
- 网关转发 + 统一异常 + 审计日志验证

---

## 6. 测试计划

### 6.1 单元测试

- `BusinessException` 与 `ErrorCode` 映射
- `RateLimit` 触发行为
- `SensitiveMasker` 脱敏规则

### 6.2 集成测试

- 网关鉴权流程
- Nacos 配置加载
- MyBatis-Plus 基础 CRUD

### 6.3 冒烟测试

- compose 启动后 5 分钟内所有核心服务健康
- API 文档可访问
- 关键日志字段可检索

---

## 7. 时间计划（建议）

- Day 1：父工程 + Compose + Nacos
- Day 2：gateway + user-service 骨架
- Day 3：common-core + common-servlet
- Day 4：common-integration + 联调修整
- Day 5：content-service 接入 + 联调 + 验收

---

## 8. 风险与缓解

1. Nacos 连接不稳定
- 缓解：保留本地 fallback 配置

2. 网关规则错误导致全站不可达
- 缓解：白名单回退路由与紧急旁路配置

3. 限流误伤正常请求
- 缓解：分组配置化阈值 + 观察窗口

4. 公共库过度设计
- 缓解：先最小实现，按实际复用再扩展

---

## 9. 阶段完成定义（DoD）

满足以下全部条件即视为第一阶段完成：

1. 基础服务可稳定启动并互通
2. 网关鉴权+限流+trace 正常
3. 公共组件在至少两个服务生效
4. 文档、配置、测试与代码一致
5. 可交给下一阶段直接开发业务功能
