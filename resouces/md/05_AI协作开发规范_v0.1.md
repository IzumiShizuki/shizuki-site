# AI 协作开发规范（v0.1）

> 文档定位：给后续 AI/自动化代码助手使用的项目内执行规范。  
> 更新时间：2026-02-08

---

## 0. 适用范围

- 适用于本仓库所有模块：`libs/*`、`services/*`、`resouces/*`、`scripts/*`。
- 本文优先级高于“个人习惯”，低于“明确产品需求”与“安全要求”。

---

## 1. 必须遵守（MUST）

### 1.1 API 与协议约束

- 对外接口主路径固定：`/api/v1/**`，不得随意改动。
- URL 使用小写 + kebab-case。
- Query 参数与 JSON 字段统一 snake_case。
- 失败响应统一 `application/problem+json`（由全局异常处理输出）。
- 透传/返回链路追踪头：`X-Request-Id`、`X-Trace-Id`。

### 1.2 架构与代码组织约束

- 业务实现统一采用 `Service` + `ServiceImpl` 模式。
- 禁止新增 `Db**Facade` 风格实现。
- Spring 依赖注入优先构造器注入，避免字段注入。
- Java 代码禁止 `import static`，统一使用显式类名调用（避免语义歧义）。
- 复用公共库能力优先，禁止在业务模块重复造轮子。
- 保持现有文档风格与结构，文档更新以“最小改动”为原则。

### 1.3 数据与迁移约束

- 运行时数据库迁移以 Flyway 为准：`services/*/src/main/resources/db/migration/*.sql`。
- `resouces/sql/*.sql` 作为人工导入/说明视图，仍需持续维护。
- `resouces/sql/*.sql` 每次增量必须追加：
  - `-- modified_at: yyyy-MM-dd HH:mm:ss`
  - `-- change: ...`
- 建表字段必须补齐列级 `COMMENT` 注释。
- Flyway 脚本命名必须符合：`V<version>__<desc>.sql`。
- 数据库对象命名必须遵循：
  - 表：`<模块缩写>_<功能>`（如 `USR_ACCOUNT`、`AI_SESSION`）
  - 视图：`VW_<表名>`
  - 唯一键：`AK_<表名>_<n>`
  - 外键：`FK_<表名>_<n>`
  - 索引：`IX_<表名>_<n>`
  - 逻辑序列：`SQ_<表名>[_n]`（MySQL 物理实现为 `AUTO_INCREMENT`）
- 字段命名与基线约束：
  - 每张业务表必须包含 `id/create_time/update_time`
  - 自增主键字段统一 `id`
  - 用户可见业务编号后缀：文本 `_code`，数值 `_num`
  - 备注后缀 `_memo`，时间后缀 `_datetime`，日期后缀 `_date`
  - 状态后缀 `_status`，类型后缀 `_type`，标记后缀 `_flag`
- 命名映射文件：`resouces/sql/00_object_name_mapping.yaml`（后续新增表必须同步维护）。
- 历史迁移脚本（V1~V4）仅允许增量修复，禁止回写导致 Flyway checksum 漂移。

### 1.4 安全与配置约束

- Token 头格式固定：`Authorization: Bearer <token>`。
- 密钥禁止写死在代码中；默认从 Nacos/环境变量读取。
- `shizuki.security.secret.enforce=true` 时，密钥占位值必须阻止启动。
- 涉及鉴权的接口必须评估并使用 `@RequireGroup`/`@RequirePermission`。
- 禁止明文落库存储敏感信息（口令、token、密钥）：
  - 密码字段统一 `password_hash`（BCrypt/Argon2）
  - 涉及密文字段统一 `*_ciphertext + *_key_version` 组合
  - SQL/seed 中禁止出现明文口令示例（如 `admin123`）。

---

## 2. 开发过程约束（执行顺序）

1. 先查公共库是否已有同类能力，再决定新增代码位置。  
2. 新接口先补 OpenAPI 注解（`@Tag`、`@Operation`、`@Schema`）。  
3. 复杂方法必须写简短注释，解释关键分支、状态流转或算法意图。  
4. 涉及 SQL 变更必须同步 Flyway 脚本与 `resouces/sql`。  
5. 提交前至少执行：
   - `./scripts/check_sql_conventions.sh`
   - `mvn -DskipTests compile`
   - 有条件时执行 `mvn test`

---

## 3. 可直接复用的工具类与能力

## 3.1 common-core（基础模型与通用能力）

- `ApiResponse`、`PageResponse`：统一返回结构。
- `ErrorCode`、`BusinessException`：统一业务异常与错误码。
- `BaseEntity`：通用实体基类字段。
- `ClockProvider`、`SystemClockProvider`：统一时间来源，便于测试。
- `SecretValueValidator`：密钥值合法性校验（防占位值上线）。

## 3.2 common-servlet（Web/安全/审计/限流/XSS）

- Web：
  - `GlobalExceptionHandler`
  - `RequestIdFilter`、`TraceIdFilter`
  - `WebMvcConfig`（snake_case、CORS）
- 安全：
  - `LoginUserContext`、`LoginUserContextFilter`
  - `@RequireGroup`、`@RequirePermission`
  - `PermissionAspect`、`AclChecker`
- 审计：
  - `@AuditLog`、`AuditLogAspect`
  - `JdbcAuditLogService`、`LoggingAuditLogService`
  - `AuditLogQueryController`
  - outbox 相关：`AuditOutboxService`、`JdbcAuditOutboxServiceImpl`、`AuditOutboxRetryTask`
  - publisher 扩展：`Noop/Kafka/ElkAuditOutboxPublisher`（Kafka/ELK 当前为 stub）
- 限流与配额：
  - `@RateLimit`
  - `RateLimitAspect`
  - `LocalRateLimiter`
  - `QuotaService`（`InMemoryQuotaService` 为当前兜底实现）
- 内容安全：
  - `HtmlSanitizerService`
  - `ExternalLinkRelRewriter`

## 3.3 common-integration（外部系统接入）

- 存储：
  - `ObjectStorageClient`
  - `AliyunOssClient`
  - `OssProperties`
  - `OssKeyBuilder`
  - `UploadValidator`
- OAuth：
  - `GitHubOAuthClient`
  - `OAuthProperties`
  - `OAuthStateService`、`RedisOAuthStateService`

---

## 4. 脚本与工具入口

- 中间件启动：`scripts/up-middleware.sh`
- 中间件停止：`scripts/down-middleware.sh`
- SQL 规范校验：`scripts/check_sql_conventions.sh`
- 一键中间件编排：`compose.yaml`

---

## 5. 提交与变更说明规范

- Git 提交信息必须符合：`emoji type : description`
- 示例：
  - `✨ feat : 新增用户偏好同步接口`
  - `🐛 fix : 修复 OAuth state 校验失效`
  - `📝 docs : 更新改造计划文档`
- 涉及以下变更时，必须同步更新 `resouces/md` 对应文档：
  - 架构/模块边界变化
  - 中间件与配置项变化
  - 迁移脚本与数据库结构变化
  - 安全策略与鉴权流程变化

---

## 6. 明确禁止项

- 禁止绕过公共库在各服务重复实现相同基础能力。
- 禁止直接提交明文密钥或占位默认值到生产配置。
- 禁止只改 `resouces/sql` 而不补 Flyway 迁移脚本。
- 禁止无文档说明的大范围结构性改动。
