# AI 协作开发规范（v0.1）

> 文档定位：给后续 AI/自动化代码助手使用的项目内执行规范。  
> 更新时间：2026-02-12

---

## 0. 适用范围

- 适用于本仓库所有模块：`libs/*`、`services/*`、`resouces/*`、`scripts/*`。
- 本文优先级高于“个人习惯”，低于“明确产品需求”与“安全要求”。

---

## 1. 必须遵守（MUST）

### 1.1 API 与协议约束

- 对外接口主路径固定：`/api/v1/**`，不得随意改动。
- 认证相关接口统一使用新路径：`/api/v1/auth/**`、`/api/v1/me/bindings/**`；禁止新增使用旧 `/api/v1/oauth-logins/**` 与 `/api/v1/auth/login`。
- URL 使用小写 + kebab-case。
- Query 参数与 JSON 字段统一 snake_case。
- Controller 对外响应默认使用强类型 DTO，禁止以 `Map<String,Object>` 作为稳定公共契约（仅允许临时调试接口例外）。
- 失败响应统一 `application/problem+json`（由全局异常处理输出）。
- 透传/返回链路追踪头：`X-Request-Id`、`X-Trace-Id`。
- 高频接口（上传策略、下载地址、验证码、搜索类）必须评估并配置 `@RateLimit`，键名需可读且稳定（如 `assets.download-url`）。
- 轻应用（widgets）布局边界固定：`position/size` 属于前端内存态，禁止设计为后端持久化字段或同步接口参数；后端仅保留“轻应用清单 + 业务参数”。

### 1.2 架构与代码组织约束

- 业务实现统一采用 `Service` + `ServiceImpl` 模式。
- 禁止新增 `Db**Service` 风格实现。
- Spring 依赖注入优先构造器注入，避免字段注入。
- Java 代码禁止 `import static`，统一使用显式类名调用（避免语义歧义）。
- 复用公共库能力优先，禁止在业务模块重复造轮子。
- 认证扩展必须遵循“策略 + 工厂”分发：`AuthGrantStrategyFactory`（grant 分发）与 `OAuthProviderStrategyFactory`（provider 分发）。
- 保持现有文档风格与结构，文档更新以“最小改动”为原则。

### 1.3 数据与迁移约束

- 运行时数据库迁移以 Flyway 为准：`services/*/src/main/resources/db/migration/*.sql`。
- `resouces/sql/*.sql` 作为人工导入/说明视图，仍需持续维护。
- `resouces/sql/*.sql` 每次增量必须追加：
  - `-- modified_at: yyyy-MM-dd HH:mm:ss`
  - `-- change: ...`
- 建表字段必须补齐列级 `COMMENT` 注释。
- Flyway 脚本命名必须符合：`V<version>__<desc>.sql`。
- 数据库对象命名必须遵循：
  - 表：`<模块缩写>_<功能>`（如 `USR_ACCOUNT`、`AI_SESSION`）
  - 视图：`VW_<表名>`
  - 唯一键：`AK_<表名>_<n>`
  - 外键：`FK_<表名>_<n>`
  - 索引：`IX_<表名>_<n>`
  - 逻辑序列：`SQ_<表名>[_n]`（MySQL 物理实现为 `AUTO_INCREMENT`）
- 字段命名与基线约束：
  - 每张业务表必须包含 `id/create_time/update_time`
  - 自增主键字段统一 `id`
  - 用户可见业务编号后缀：文本 `_code`，数值 `_num`
  - 备注后缀 `_memo`，时间后缀 `_datetime`，日期后缀 `_date`
  - 状态后缀 `_status`，类型后缀 `_type`，标记后缀 `_flag`
- 命名映射文件：`resouces/sql/00_object_name_mapping.yaml`（后续新增表必须同步维护）。
- 历史迁移脚本默认禁止回写导致 Flyway checksum 漂移；仅在“未发布环境、团队已明确确认”的前提下允许调整早期脚本（如 V1/V2），并必须同步更新 `resouces/sql` 与实施文档。
- 若模块确认“尚未正式部署数据库”，可将增量迁移并入 `V1__init_schema.sql` 收敛基线；落地时必须删除对应增量脚本并在 `resouces/md` 记录原因与日期。

### 1.4 安全与配置约束

- Token 头格式固定：`Authorization: Bearer <token>`。
- 密钥禁止写死在代码中；默认从 Nacos/环境变量读取。
- `shizuki.auth.jwt.secret` 必须来自配置；允许在本地开发使用 `${random.uuid}` 兜底，但生产必须显式配置强密钥。
- `shizuki.security.secret.enforce=true` 时，密钥占位值必须阻止启动。
- 涉及鉴权的接口必须评估并使用 `@RequireGroup`/`@RequirePermission`。
- 禁止明文落库存储敏感信息（口令、token、密钥）：
  - 密码字段统一 `password_hash`（BCrypt/Argon2）
  - 涉及密文字段统一 `*_ciphertext + *_key_version` 组合
  - SQL/seed 中禁止出现明文口令示例（如 `admin123`）。
- 线上可观测日志优先中文描述，便于运维快速定位；结构化字段（如 `reason/upstream_status`）必须保留。
- 服务间敏感 internal 接口（如 `/api/v1/internal/music/api-keys/**`）必须启用请求签名校验，禁止仅依赖网络边界放行：
  - 必需请求头：`X-Internal-Service`、`X-Internal-Timestamp`、`X-Internal-Nonce`、`X-Internal-Signature`
  - canonical 串格式：`method + \"\\n\" + path + \"\\n\" + query + \"\\n\" + timestamp + \"\\n\" + nonce`
  - 算法：`HMAC-SHA256(shared-secret, canonical-string)`
  - 时钟漂移默认 `<=300s`，nonce 必须做 Redis 去重（TTL 与漂移一致）
  - 校验顺序要求：先验签，再写 nonce 去重，避免恶意请求污染 nonce 集合

### 1.5 认证与韧性专项约束

- 网关 introspect 错误语义固定：
  - `4xx -> 401`
  - `timeout/5xx/network/invalid_payload -> 503`
- guest 路径坏 token 默认 `downgrade`（降级游客），可通过 `guest-invalid-token-policy=reject` 切换严格拒绝。
- 游客身份约定固定：`X-User-Id=0`、`X-User-Groups=GUEST`。
- 游客 AI 配额策略固定为 `ai_round_total=0`（当前策略）。
- 禁止在业务线程手写 `Thread.sleep` 退避；跨服务调用重试统一复用 `SpringRetryExecutor`。
- 重试边界必须明确：
  - `4xx` 不重试
  - `timeout/network/5xx` 可重试（指数退避 + jitter + 上限）
- 图形验证码必须一次一用，且要有失败次数上限（`image-max-attempts`）。

### 1.6 注释与可读性约束

- 对外 Controller、Service 接口、ServiceImpl 必须补齐类注释，说明职责边界。
- 对外 `public` 方法必须补齐方法注释，至少包含“做什么 + 关键入参语义 + 返回语义”。
- 复杂分支必须写“原因型注释”（解释为什么这样做），禁止只写“动作复述型注释”（例如“给变量赋值”）。
- 涉及兼容逻辑（如新旧字段回退）、安全逻辑（如 Zip Slip 防护）、策略逻辑（如公开/私有桶映射）必须加行内注释。
- DTO/Entity 新增关键字段时，建议补字段语义注释（特别是 code 枚举、flag、json 扩展字段）。
- 注释语言默认中文；术语与字段名保持英文原文（例如 `asset_kind_code`、`publicBaseUrl`）。
- 修改代码行为时必须同步检查并更新相关注释，禁止“过期注释”留存。

### 1.7 注释与注解示例模板（推荐）

- `Service` 接口：写完整方法注释（职责、关键参数、返回语义）。
- `ServiceImpl`：优先使用 `/** {@inheritDoc} */`，避免接口与实现重复维护两份说明。
- `private` 复杂方法：必须写“为什么这样做”的原因型注释。
- `Controller`：保留 `@Tag` + `@Operation`，必要时补 `@ApiResponses`。

示例（Service 接口）：

```java
/**
 * 执行一次选歌。
 *
 * @param request 选歌请求（provider 与关键字）
 * @return 选中的曲目与选歌后配额状态
 */
MusicPickResponse pickMusic(MusicPickRequest request);
```

示例（ServiceImpl）：

```java
/**
 * {@inheritDoc}
 */
@Override
public MusicPickResponse pickMusic(MusicPickRequest request) {
    // 超额后要求用户绑定 key，避免平台代付被无限消耗。
    if (used >= total && !keyBound) {
        throw new BusinessException(ErrorCode.FORBIDDEN, "Music API key required");
    }
    return result;
}
```

示例（Controller）：

```java
@RestController
@RequestMapping("/api/v1/music")
@Tag(name = "Music", description = "音乐播放器前台接口")
public class MusicController {

    /**
     * 查询默认歌单（游客可访问）。
     */
    @GetMapping("/playlist/default")
    @Operation(summary = "查询默认歌单", description = "游客和登录用户均可访问")
    public ApiResponse<List<MusicTrackResponse>> defaultPlaylist() {
        return ApiResponse.success(mediaService.listDefaultMusicPlaylist());
    }
}
```

---

## 2. 开发过程约束（执行顺序）

1. 先查公共库是否已有同类能力，再决定新增代码位置。  
2. 新接口先补 OpenAPI 注解（`@Tag`、`@Operation`、`@Schema`）。  
3. 复杂方法必须写简短注释，解释关键分支、状态流转或算法意图；优先写“为什么”而不是“做了什么”。  
4. 涉及 SQL 变更必须同步 Flyway 脚本与 `resouces/sql`。  
5. 提交前至少执行：
   - `./scripts/check_sql_conventions.sh`
   - `mvn -DskipTests compile`
   - 有条件时执行 `mvn test`
   - 认证/网关/配额改动必须补跑定向测试（示例：`Auth*Test`、`ImageCaptchaServiceTest`、`AuthGatewayFilterTest`、`UserQuotaClientTest`）

---

## 3. 可直接复用的工具类与能力

## 3.1 common-core（基础模型与通用能力）

- `ApiResponse`、`PageResponse`：统一返回结构。
- `ErrorCode`、`BusinessException`：统一业务异常与错误码。
- `BaseEntity`：通用实体基类字段。
- `ClockProvider`、`SystemClockProvider`：统一时间来源，便于测试。
- `SecretValueValidator`：密钥值合法性校验（防占位值上线）。
- `RetrySpec`、`SpringRetryExecutor`：统一重试执行器（指数退避 + jitter + cap）。

## 3.2 common-servlet（Web/安全/审计/限流/XSS）

- Web：
  - `GlobalExceptionHandler`
  - `RequestIdFilter`、`TraceIdFilter`
  - `WebMvcConfig`（snake_case、CORS）
- 安全：
  - `LoginUserContext`、`LoginUserContextFilter`
  - `@RequireGroup`、`@RequirePermission`
  - `PermissionAspect`、`AclChecker`
- 审计：
  - `@AuditLog`、`AuditLogAspect`
  - `JdbcAuditLogService`、`LoggingAuditLogService`
  - `AuditLogQueryController`
  - outbox 相关：`AuditOutboxService`、`JdbcAuditOutboxServiceImpl`、`AuditOutboxRetryTask`
  - outbox 回收：`PROCESSING` 超时事件自动回收（避免实例异常退出后卡死）
  - publisher 扩展：`Noop/Kafka/ElkAuditOutboxPublisher`（Kafka/ELK 当前为 stub）
- 限流与配额：
  - `@RateLimit`
  - `RateLimitAspect`
  - `LocalRateLimiter`
  - `QuotaService`（`InMemoryQuotaService` 为当前兜底实现）
- 内容安全：
  - `HtmlSanitizerService`
  - `ExternalLinkRelRewriter`

## 3.3 common-integration（外部系统接入）

- 存储：
  - `ObjectStorageClient`
  - `AliyunOssClient`
  - `OssProperties`
  - `OssKeyBuilder`
  - `UploadValidator`
- OAuth：
  - `OAuthProperties`
  - `OAuthProviderProperties`
  - `OAuthStateService`、`RedisOAuthStateService`
  - `OAuthProviderStrategyFactory`
  - `GitHubOAuthProviderStrategy`、`LinuxDoOAuthProviderStrategy`
  - `OAuthIdentity`

---

## 4. 脚本与工具入口

- 中间件启动：`scripts/up-middleware.sh`
- 中间件停止：`scripts/down-middleware.sh`
- SQL 规范校验：`scripts/check_sql_conventions.sh`
- 一键中间件编排：`compose.yaml`

---

## 5. 提交与变更说明规范

- Git 提交信息必须符合：`emoji type : description`
- 示例：
  - `✨ feat : 新增用户偏好同步接口`
  - `🐛 fix : 修复 OAuth state 校验失效`
  - `📝 docs : 更新改造计划文档`
- 涉及以下变更时，必须同步更新 `resouces/md` 对应文档：
  - 架构/模块边界变化
  - 中间件与配置项变化
  - 迁移脚本与数据库结构变化
  - 安全策略与鉴权流程变化

---

## 6. 明确禁止项

- 禁止绕过公共库在各服务重复实现相同基础能力。
- 禁止直接提交明文密钥或占位默认值到生产配置。
- 禁止只改 `resouces/sql` 而不补 Flyway 迁移脚本。
- 禁止无文档说明的大范围结构性改动。
- 禁止在业务代码中手写循环 + `sleep` 重试（统一走 resilience 组件）。
- 禁止在鉴权失败日志中丢失关键结构化字段（至少包含 `reason`、`upstream_status`）。
