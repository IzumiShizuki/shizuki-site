# 个人学习陪伴网站｜代码开发文档（v0.2）

> 目标：按本文件可直接开始工程搭建、接口开发、联调与部署。

---

## 0. 约束与规范（MUST）

### 0.1 API 规范

- Base Path：`/api/v1`
- URL：小写 + kebab-case + 复数资源名（禁止动词 URL）
- Query 与 JSON 字段：snake_case
- 错误响应：`application/problem+json`
- Trace：请求头必须透传 `X-Request-Id` 与 `X-Trace-Id`

### 0.2 安全基线

- 按 OWASP ASVS L1 验收。
- 强制落地：鉴权、限流、配额、白名单、审计。

### 0.3 代码门禁

- Java 17
- 统一静态检查：P3C + Checkstyle/PMD（二选一但必须启用）
- OpenAPI 文档必须随代码更新
- 无测试、无文档的接口不允许合并

---

## 1. 技术栈定稿

### 1.1 后端

- `Spring Boot 3.x`
- `Spring Cloud Gateway`
- `Spring Cloud Alibaba Nacos`
- `Sa-Token`
- `MyBatis-Plus`
- `MySQL 8.x`
- `Redis 7.x`
- `springdoc-openapi`
- `Micrometer Tracing`
- `Aliyun OSS SDK`

### 1.2 前端（方向约束）

- Vue 3 或 React（二选一）
- 样式：Glassmorphism
- Dock 拖拽：Interact.js
- Widgets 网格：Gridstack
- 轮播：Swiper
- 图标：IconPark
- 编辑器：TOAST UI Editor
- HTML 净化：DOMPurify

---

## 2. 工程结构（Monorepo）

```text
repo-root/
  resouces/md/
    01_总体设计文档_v0.1.md
    02_代码开发文档_v0.1.md
    03_框架与工具类搭建计划_v0.1.md
  services/
    gateway-service/
    user-service/
    content-service/
    media-service/
    ai-service/
  libs/
    common-core/
    common-servlet/
    common-integration/
  compose.yaml
  .github/workflows/
```

---

## 3. 公共库（统一工具类/Starter）

### 3.1 common-core

- `ApiResponse<T>` / `PageResponse<T>`
- `ErrorCode`
- `BusinessException`
- `BaseEntity`（`id/created_at/updated_at/deleted/version`）
- `ClockProvider`

### 3.2 common-servlet（聚合 web/security/audit/rate-limit/xss）

- Web 层：
  - `GlobalExceptionHandler`（输出 ProblemDetails）
  - `TraceIdFilter` / `RequestIdFilter`
  - `WebMvcConfig`（CORS、Jackson snake_case、参数校验）
- 安全层：
  - Sa-Token 配置（Header、TTL、active-timeout）
  - `LoginUserContext`
  - 注解：`@RequirePermission`、`@RequireGroup`
  - `AclChecker`（资源级鉴权）
- 审计层：
  - 注解：`@AuditLog(action, resource)`
  - AOP 切面：自动采集操作审计
  - `SensitiveMasker`（敏感字段脱敏）
  - `AuditLogService`
- 限流层：
  - Redis 计数限流（失败时本地兜底）
  - 注解：`@RateLimit`
  - `QuotaService`：配额消费与查询
- 内容安全：
  - OWASP HTML Sanitizer 封装
  - allowlist 策略模板（博客/评论/富文本）
  - 外链 rel 重写

### 3.3 common-integration（聚合 storage/oauth）

- 存储适配：
  - `ObjectStorageClient` 接口：上传、删除、GET/PUT 签名 URL
  - `AliyunOssClient` 实现
  - `OssKeyBuilder`（统一 key 规则）
  - `UploadValidator`（MIME/大小/数量）
- OAuth 适配：
  - GitHub + LinuxDo OAuth2 授权码模式
  - state 管理（Redis）
  - 统一 provider 抽象（`OAuthProviderStrategyFactory`）
  - grant 分发抽象（`AuthGrantStrategyFactory`）

---

## 4. 服务职责与关键接口（首期必须）

### 4.1 gateway-service

职责：
- 路由转发
- 统一鉴权
- 统一限流（非 ADMIN 默认 30/min）
- traceId 注入与透传

关键配置：
- 路由规则由 Nacos 下发
- 白名单路径（登录、公开资源、健康检查）
- 管理路由需显式配置到网关：
  - `/api/v1/admin/users/**`
  - `/api/v1/admin/groups/**`
  - `/api/v1/admin/posts/**`
  - `/api/v1/admin/apps/**`
- 鉴权错误语义固定：`4xx -> 401`，`timeout/5xx/network -> 503`
- `guest-invalid-token-policy` 默认 `downgrade`，可切换 `reject`

### 4.2 user-service

职责：
- 用户、分组、角色、权限
- 统一认证（邮箱密码 / OAuth / refresh）
- 偏好同步
- 配额策略管理

关键接口：
- `POST /api/v1/auth/tokens`
- `POST /api/v1/auth/oauth/authorizations`
- `POST /api/v1/auth/register/email`
- `POST /api/v1/auth/verifications/email/send`
- `GET /api/v1/auth/captchas/image`
- `POST /api/v1/auth/bindings/confirm`
- `POST /api/v1/auth/logout`
- `GET /api/v1/auth/introspect`
- `GET /api/v1/me`
- `GET /api/v1/me/preferences`
- `PUT /api/v1/me/preferences`
- `POST /api/v1/me/bindings/email`
- `POST /api/v1/me/bindings/oauth`
- `GET /api/v1/admin/group-quota-policies`
- `PUT /api/v1/admin/group-quota-policies/{policy_id}`
- `GET /api/v1/admin/users/{user_id}/groups`
- `PUT /api/v1/admin/users/{user_id}/groups`
- `GET /api/v1/admin/groups/permissions`
- `GET /api/v1/admin/groups/{group_code}/permissions`
- `PUT /api/v1/admin/groups/{group_code}/permissions`

实现口径（必须一致）：
- `introspect` 权限 = 用户直配权限 + 分组权限并集。
- 多分组配额冲突按最大值返回（高权限优先）。

### 4.3 content-service

职责：
- 帖子/应用列表与互动
- 三态可见性管理（帖子/应用）
- 举报

关键接口：
- `GET /api/v1/posts`
- `POST /api/v1/posts/{post_id}/likes`
- `GET /api/v1/apps`
- `POST /api/v1/apps/{app_id}/likes`
- `POST /api/v1/reports`
- `GET /api/v1/admin/posts/{post_id}/visibility`
- `PUT /api/v1/admin/posts/{post_id}/visibility`
- `GET /api/v1/admin/apps/{app_id}/visibility`
- `PUT /api/v1/admin/apps/{app_id}/visibility`

实现口径（必须一致）：
- 可见性三态：`PUBLIC` / `PRIVATE` / `GROUP`。
- 列表与点赞都执行可见性校验；举报接口本轮不做可见性拦截。

### 4.4 media-service

职责：
- 资源元数据管理
- OSS 上传策略签发
- 三态可见性与分组 ACL
- 公开/私有资源下载
- 资源审核（管理员）

关键接口：
- `POST /api/v1/assets/upload-policies`
- `POST /api/v1/assets`
- `GET /api/v1/assets/{asset_id}/download-url`
- `GET /api/v1/assets/public/home-roles`
- `POST /api/v1/assets/{asset_id}/reports`
- `PUT /api/v1/admin/assets/{asset_id}/audit-status`

实现口径（必须一致）：
- `AssetCreateRequest` 与 `AdminAssetUpdateRequest` 支持 `allowed_group_codes`。
- `GROUP` 可见资源通过关联表 `MDA_ASSET_GROUP_ACL` 存储授权分组。

### 4.5 ai-service

职责：
- 会话与消息
- 世界书与角色卡
- 配额校验与扣减
- OpenAI Compatible 调用

关键接口：
- `POST /api/v1/ai-sessions`
- `GET /api/v1/ai-sessions`
- `POST /api/v1/ai-sessions/{session_id}/messages`
- `GET /api/v1/ai-quotas/me`
- `POST /api/v1/ai-characters`
- `POST /api/v1/ai-character-cards/import`

---

## 5. 数据库设计（MyBatis-Plus 对齐）

### 5.1 通用字段规范

所有业务表默认包含：
- `id`（BIGINT）
- `create_time`、`update_time`
- `deleted_flag`（逻辑删除）
- `version_num`（乐观锁）

说明：首期已落地核心表以业务可用优先，后续在迁移治理阶段统一补齐 `deleted/version` 规范。

### 5.2 用户与权限

- `user`
- `group`
- `role`
- `permission`
- `user_group_membership`
- `user_role`
- `role_permission`

建议索引：
- `user(email)` 唯一
- `user(github_id)` 唯一
- `user_group_membership(user_id, group_id)` 唯一

### 5.3 策略与白名单

- `module`
- `group_module_policy`
- `quota_policy`
- `group_quota_policy`
- `email_domain_whitelist`
- `external_link_whitelist`
- `iframe_domain_whitelist`

建议索引：
- `group_module_policy(group_id, module_code)` 唯一
- `group_quota_policy(group_id, quota_code)` 唯一

### 5.4 偏好

- `user_preference(user_id, preference_json, version, updated_at)`

建议索引：
- `user_preference(user_id)` 唯一

### 5.5 内容

- `post`
- `post_like`
- `post_view_event`
- `comment`
- `report`
- `app`
- `app_like`
- `app_comment`
- `app_view_event`

### 5.6 资源

- `asset`
- `asset_like`
- `asset_report`
- `asset_audit_record`

### 5.7 AI

- `ai_credential`
- `ai_session`
- `ai_message`
- `ai_worldbook`
- `ai_worldbook_entry`
- `ai_character`
- `ai_quota_usage`

关键约束：
- `ai_quota_usage(user_id, quota_code)` 唯一

### 5.8 审计

- `audit_log`

### 5.9 当前落地库表（Flyway 基线）

`user-service`：
- `USR_ACCOUNT`
- `USR_PREFERENCE`
- `USR_QUOTA_POLICY`
- `USR_GROUP_PERMISSION`
- `OAU_LOGIN`
- `OAU_BINDING`

`content-service`：
- `CTN_POST`
- `CTN_APP`
- `CTN_POST_GROUP_ACL`
- `CTN_APP_GROUP_ACL`
- `CTN_REPORT`

`media-service`：
- `MDA_ASSET`
- `MDA_ASSET_GROUP_ACL`
- `MDA_L2D_PACKAGE`
- `MDA_REPORT`

### 5.10 迁移策略（当前阶段）

- 本轮“角色组并集 + 三态可见性”变更采用未部署库策略：直接修改对应服务的 `V1__init_schema.sql` / `V2__seed_data.sql`。
- 不新增本需求相关 `V3/V4` 迁移文件。
- `user-service` 既有 `V3__auth_upgrade.sql` 属于历史认证改造，不属于本轮三态可见性改造。

---

## 6. MyBatis-Plus 实施规范

### 6.1 插件

必须启用：
- 分页插件
- 乐观锁插件
- 逻辑删除

### 6.2 分层

- `entity`：数据库实体
- `mapper`：`BaseMapper<T>` + 自定义 SQL
- `service`：业务编排
- `service.impl`：实现层
- `controller`：REST 接口层

### 6.3 SQL 策略

- 简单 CRUD 使用 MyBatis-Plus。
- 复杂聚合查询使用 XML 显式 SQL。
- 禁止在 Controller 拼 SQL 或写复杂业务规则。

---

## 7. CI/CD（GitHub Actions 建议）

流水线：
1. `mvn -q -DskipTests=false test`
2. 静态检查（P3C + Checkstyle/PMD）
3. 生成 OpenAPI 文档并校验变更
4. 构建 Docker 镜像
5. 推送镜像（可选）

合并门禁：
- 单元测试通过
- 静态检查通过
- OpenAPI 变更有说明

---

## 8. Docker Compose（8GB 单机）

最小服务：
- `mysql`
- `redis`
- `nacos`
- `gateway-service`
- `user-service`
- `content-service`
- `media-service`
- `ai-service`

JVM 建议：
- gateway: `-Xms256m -Xmx256m`
- user: `-Xms384m -Xmx384m`
- content: `-Xms512m -Xmx512m`
- media: `-Xms384m -Xmx384m`
- ai: `-Xms768m -Xmx768m`

Secrets：
- OSS AccessKey/Secret
- GitHub OAuth Client Secret
- LinuxDo OAuth Client Secret
- DB 密码
- Redis 密码
- `AUTH_JWT_SECRET`（JWT 签名密钥）

---

## 9. 首期开发顺序（必须遵守）

1. 父工程 + libs 公共库完成
2. gateway + nacos + user-service 打通登录链路
3. content/media 基础 CRUD 与资源链路
4. ai-service 会话与配额能力
5. 联调、压测、上线前安全检查

---

## 10. 对齐清单（对当前仓库）

1. [已完成] `pom.xml`：已改为多模块父工程并引入 MyBatis-Plus、Nacos、Gateway 依赖管理。
2. [已完成] `compose.yaml`：已补齐中间件与 5 服务容器模板。
3. [已完成] 配置体系：已迁移为多服务 `application.yml + bootstrap.yml + Nacos yaml` 模式。
4. [已完成] 认证主链路：已切换统一 `/api/v1/auth/tokens` + OAuth provider 策略工厂（GitHub/LinuxDo）+ `bind_ticket` 显式确认。
5. [待收尾] 文档与联调：补齐端到端联调说明与集成测试执行手册。
