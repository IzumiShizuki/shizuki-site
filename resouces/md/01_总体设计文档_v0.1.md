# 个人学习陪伴网站｜总体设计文档（v0.2）

- 文档目标：统一产品边界、架构决策、安全基线、容量预算，支持直接开工。
- 适用阶段：MVP 到小规模上线（单机 8GB，Docker Compose）。
- 决策状态：本版为已定稿版本，避免“边做边改”导致反复返工。

---

## 0. 核心结论

1. 首页默认进入「学习陪伴页」：动态角色 + 背景 + 声音系统 + Floating Dock + Widgets。
2. 架构采用 **立即微服务**：`gateway-service`、`user-service`、`content-service`、`media-service`、`ai-service`。
3. 技术基线：`Java 17 + Spring Boot 3.x + Spring Cloud Gateway + Nacos + MyBatis-Plus + MySQL + Redis + OSS + Sa-Token`。
4. AI 配额口径固定：无自带 API 用户为 **总生命周期 5 轮**（一问一答=1轮）；自带 API 不限总轮数但仍受限流保护。
5. API 路由统一为 `/api/v1/**`，禁止 `/v1/**` 与 `/api/v1/**` 混用。
6. 安全基线采用 OWASP ASVS L1：强制限流、配额、白名单、审计日志与可止损开关。
7. 部署目标为单机 8GB：中间件与服务可控运行，预留约 1GB 内存缓冲。

---

## 1. 产品定位与目标

### 1.1 定位

个人长期使用的学习陪伴站点，四大核心能力：
- 陪伴：角色、背景、环境音、专注工具。
- 内容：博客、时间线、项目展示。
- 互动：评论、点赞、举报、可配置可见性。
- AI：角色卡、世界书、会话历史、OpenAI 兼容调用。

### 1.2 成功标准（可量化）

- 游客打开首页 3 秒内可完成首屏渲染并可触发播放。
- 登录用户偏好可跨设备同步（Dock、Widget 清单/参数、背景、声音预设）。
- Widget 位置与尺寸属于前端运行时内存态，不做后端跨端同步。
- 管理员可在 1 分钟内完成模块止损（关模块、改配额、改白名单）。
- 接口风格统一，OpenAPI 可自动生成并用于联调。

### 1.3 设计原则

- 可扩展：策略化优先（配额、白名单、模块开关均走配置）。
- 可维护：强制统一命名与错误模型，避免服务间风格漂移。
- 可止损：网关限流 + 服务配额 + 维护开关三层保护。
- 可降本：媒体对象存 OSS，计算留给业务服务，首期不引入重型组件。

---

## 2. 用户体系与权限模型

### 2.1 分组（Group）

- `GUEST`：公开浏览。
- `USER`：基础功能与个人偏好。
- `INTERVIEWER`：临时高权限分组，默认 3 天后自动降级。
- `FRIEND`：受邀分组，能力高于 USER。
- `ADMIN`：全站管理。

### 2.2 角色与权限点（Role + Permission）

- 权限命名：`module.action`，示例：`blog.post.create`、`media.asset.audit`。
- 计算规则：
  - 权限：并集。
  - 配额：取最严格。
  - 模块开关：任一分组禁用则禁用（ADMIN 可覆盖）。

### 2.3 面试官分组规则

- 通过隐藏入口 + secret 触发加入。
- 有效期默认 72 小时，支持后台改“降级目标分组”。
- 到期自动回收高风险能力（如 PNG 角色卡导入、图像生成能力）。

### 2.4 鉴权模型

- 采用 Sa-Token，Token 走 Header。
- 网关做统一鉴权与限流；业务服务做资源级二次鉴权（防绕过）。

---

## 3. 信息架构与交互

### 3.1 首页（学习陪伴页）

- 视觉：Glassmorphism（圆角、半透明、背景模糊）。
- 背景：按页面分区配置（Home/博客列表/文章页/应用中心）。
- Dock：支持拖拽、吸附、排序、增删、位置记忆。
- Widgets：支持网格布局、开关、尺寸、配置 schema。
- Widgets 位置/尺寸仅在前端内存维护，刷新后按默认布局恢复。

### 3.2 数据保存策略

- 未登录：`localStorage`。
- 已登录：`/api/v1/me/preferences` 同步（仅同步 Widget 清单与业务参数，不同步位置/尺寸）。
- 并发控制：偏好保存使用 version 乐观锁。

### 3.3 声音系统

- 多轨混音（BGM + 环境音），支持预设保存。
- 首次播放必须用户手势触发（浏览器策略）。
- 音频来源：公共音轨、用户上传音轨、第三方 API 音轨。

---

## 4. 业务模块边界

### 4.1 应用中心

- 卡片字段：浏览、点赞、评论、标签、分类、是否可 pin。
- 两个核心动作：`开始使用`、`添加到首页`。
- 外链：非白名单必须确认弹窗，新标签打开并强制 `noopener,noreferrer`。

### 4.2 博客模块

- 阅读优先：列表/分类/标签/搜索/目录。
- 编辑器：TOAST UI Editor（Markdown + WYSIWYG）。
- 富文本安全：前后端双层净化，iframe 仅白名单域名允许。

### 4.3 AI 模块

- 协议：OpenAI Compatible。
- 配额：
  - 无自带 API：总 5 轮。
  - 有自带 API：不限总轮数。
- 保护：网关 30/min + ai-service 二次配额校验。
- 数据保留：会话历史默认 30 天，可手动清理。
- 角色卡：支持 `character` 与 `character_card_png` 两种资产形态。

---

## 5. 微服务架构

### 5.1 服务清单

1. `gateway-service`：入口、鉴权、限流、灰度、统一日志透传。
2. `user-service`：用户、分组、角色、权限、策略、偏好。
3. `content-service`：博客、评论、举报、应用中心元数据。
4. `media-service`：资源元数据、OSS 上传/下载策略、审核流。
5. `ai-service`：会话、消息、世界书、角色卡、配额扣减、模型调用。

### 5.2 注册与配置中心

- 采用 `Nacos`（服务注册 + 配置中心）。
- 配置分层：`common.yaml` + `service-{env}.yaml`。

### 5.3 通信与容错

- 服务间调用：HTTP + OpenFeign。
- 容错：超时、重试、熔断（首期以网关限流+调用超时为主）。
- Trace：统一 `trace_id` 贯穿网关与业务服务。

### 5.4 首期明确不引入

- 不引入 MQ（RabbitMQ/Kafka）。
- 不引入 ES。
- 不引入向量库。
- 不做分布式事务框架（通过业务补偿与幂等规避）。

### 5.5 公共库分层（定稿）

- `common-core`：纯基础模型与异常协议，不依赖具体 Web 技术栈。
- `common-servlet`：Servlet 服务共用能力（web/security/audit/rate-limit/xss）。
- `common-integration`：外部系统适配层（oauth/storage/redis-state）。
- 原则：先按 3 层稳定复用，再按实际规模细拆，避免早期“公共库过度设计”。

---

## 6. 数据与存储策略

### 6.1 存储职责

- MySQL：主数据、策略、审计。
- Redis：会话、限流、热点缓存、临时状态。
- OSS：媒体对象（公开与私有前缀隔离）。

### 6.2 OSS 分层

- 公共资源：可直链（可配 CDN）。
- 私有资源：后端签名 URL 短时访问（默认 10 分钟）。

### 6.3 命名与返回规范

- 路径：复数资源 + kebab-case。
- query 与 JSON：snake_case。
- 错误：`application/problem+json`，至少包含 `code/message/request_id/details`。

### 6.4 数据库命名与安全口径（v1.1）

- 数据库对象命名统一：
  - 表：`<模块缩写>_<功能>`（`USR/CTN/MDA/AI/AUD/OAU/SYS`）
  - 视图：`VW_<表名>`
  - 约束与索引：`AK_/FK_/IX_` 命名规范
  - 逻辑序列：`SQ_<表名>`（MySQL 以 `AUTO_INCREMENT` 落地）
- 字段规范统一：
  - 每张业务表必须包含 `id/create_time/update_time`
  - 用户可见业务编号采用 `_code` 或 `_num` 后缀
- 规范化原则：
  - 以第三范式为主，冗余字段仅允许白名单场景并注明“冗余来源”
- 安全基线：
  - 禁止明文存储敏感信息，密码统一 `password_hash`
  - 配置密钥不入库、不落日志明文

---

## 7. 安全与合规（ASVS L1）

### 7.1 必做控制

- XSS：DOMPurify（前端）+ OWASP HTML Sanitizer（后端）。
- 越权：网关鉴权 + 服务内资源级校验。
- 外链：白名单 + 确认页。
- iframe：白名单 + sandbox + CSP。
- 敏感信息脱敏：token、api_key、签名参数不得落日志。

### 7.2 可止损机制

- 全局限流开关。
- 模块维护开关（分组维度）。
- 配额实时调整。
- 白名单即时更新。

---

## 8. 可观测性与审计

### 8.1 日志

- 网关访问日志：`path/status/cost_ms/user_id/trace_id`。
- 审计日志：关键动作必记（策略修改、删除、审核、权限变更）。
- 安全日志：登录失败、权限拒绝、限流触发必须结构化。

### 8.2 审计字段建议

- `trace_id`、`user_id`、`group_ids`
- `action`、`resource_type`、`resource_id`
- `result`、`error_code`、`cost_ms`

---

## 9. 部署与容量规划（8GB 单机）

### 9.1 必选中间件

| 组件 | 作用 | 建议内存 |
|---|---|---|
| MySQL 8 | 主数据 | 1.5 GB |
| Redis 7 | 会话/缓存/限流 | 0.4 GB |
| Nacos 2.x | 注册与配置 | 0.6 GB |
| OSS | 对象存储（云托管） | 本机常驻 0 |

### 9.2 应用服务内存建议

| 服务 | JVM 建议 | 预计 RSS |
|---|---|---|
| gateway-service | `-Xms256m -Xmx256m` | 0.35 GB |
| user-service | `-Xms384m -Xmx384m` | 0.52 GB |
| content-service | `-Xms512m -Xmx512m` | 0.70 GB |
| media-service | `-Xms384m -Xmx384m` | 0.52 GB |
| ai-service | `-Xms768m -Xmx768m` | 1.05 GB |

### 9.3 总预算

- 中间件 + 服务：约 `5.64 GB`
- OS/Docker/缓存预留：约 `1.30 GB`
- 总计：约 `6.94 GB`
- 余量：约 `1.06 GB`

### 9.4 扩容触发条件

- 内存长期 > 85%
- 网关 P95 延迟 > 300ms
- ai-service CPU 持续 > 70%
- MySQL 慢查询显著增多

触发后优先扩容：`ai-service -> content-service -> MySQL`。

---

## 10. 迭代路线

- Phase 0：框架骨架、网关、鉴权、审计、统一异常。
- Phase 1：首页陪伴系统 MVP（背景/声音/Dock/Widgets）。
- Phase 2：博客与应用中心。
- Phase 3：AI 会话、角色卡、世界书。
- Phase 4：资源审核与互动增强。

---

## 11. 本版已关闭待办

- “总共 5 轮”口径已固定。
- API 前缀已固定为 `/api/v1`。
- 微服务边界已固定并与开发文档一致。

### 11.1 当前实现对齐（2026-02-08）

- Nacos 配置中心已接入：5 个服务均已新增 `bootstrap.yml`，默认地址 `192.168.88.128:8848`。
- 数据层已切换为 MyBatis-Plus 持久化实现，服务命名统一为 `Service/ServiceImpl`。
- OAuth 已打通真实链路（state 校验、code 换 token、userinfo、本地绑定/建号、登录态下发）。
- OSS 已完成真实 SDK 适配，`media-service` 已使用签名 URL 上传/下载策略。
- 审计日志已支持 DB 落库与检索，日志输出保留为降级兜底。
- SQL 目录已按分库维护（`resouces/sql/*.sql`），并补齐核心表与字段注释。
