# 个人学习陪伴网站｜总体设计文档（v0.1）

- 文档目标：把“能做什么、给谁用、怎么用、怎么扩展、怎么控风险”一次说清楚，便于你直接开工与持续迭代。
- 当前策略：个人项目优先（可维护、可演进、可止损），但仍按工程化与安全基线执行。

---

## 0. 核心结论

- 默认进入「学习陪伴页」：动态角色 + 声音系统 + 可 Pin 的 Widgets + 侧边半透明按钮组。
- 网站首页完全公开；消耗额度/需审核/高频内容登录可见；少量内容仅面试官分组可见（3 天自动降级）。
- 权限模型：**分组（策略/配额/模块开关） + 角色（细粒度权限点）**，允许用户拥有多个分组（取最严格策略保护服务器）。
- 鉴权：Sa-Token（Token 走 Header），网关统一鉴权与限流。
- 存储：MySQL + Redis + 阿里云 OSS（公开与私有前缀分层；私有资源通过预签名 URL 访问）。
- AI：兼容 OpenAI 协议；无自带 API 的用户 **总共 5 轮**；有自带 API 则不限制“总轮数”，但仍统一 30/min 限流；聊天历史保存 30 天，可自行清理。
- UI 约束：少纯色，多毛玻璃与圆角；背景图由后端下发并可分区配置；公告可轮播；图标使用 IconPark（禁止 Emoji）。

---

## 1. 产品定位与目标

### 1.1 定位
一个“长期生活系统”型个人站点：  
内容沉淀（博客/时间线）+ 作品展示（应用中心）+ 学习陪伴（角色/音乐/环境音/轻工具）+ AI 对话（角色卡/世界书/简化 RAG）。
核心体验：打开即“学习陪伴页”，轻交互、低打扰；需要消耗资源/额度/审核/高频的内容登录可见。

### 1.2 成功标准（可量化）
- 访问者无需登录也能获得完整“学习陪伴”第一体验（至少：角色动起来 + 音频可播放）。
- 登录后偏好可跨设备同步（dock 按钮/轻应用清单与参数/背景等）。
- 轻应用（widgets）位置与尺寸属于前端运行时内存态，不做后端跨端同步。
- 管理员能在 1 分钟内完成止损：关闭某模块、修改配额、调整白名单。
- API 命名与返回结构统一，文档自动生成，能长期维护。

### 1.3 系统风格参考
- Halo：主题与插件生态强，页面信息组织/阅读体验可参考，但其 GPLv3 协议意味着代码不能随便抄。

- LifeAt：沉浸背景 + 计时/任务/笔记等 widgets 的组合很贴近你要的“学习陪伴页”。

  A Soft Murmur：多轨环境音混音、滑杆控制的交互参考价值很高。

  开源环境音/混音参考：

  - Kakapo：开源环境音混音器（Web + Desktop），可以借鉴其“音轨/预设/状态管理”结构。
  - AmbientMix：浏览器端多层环境音与 Web Audio 混音的思路可借鉴

- Homepage：轻量 startpage，强调性能与 widget/integration。

### 1.4 关键设计原则

- 可拓展性：模块化、策略化（权限/配额/存储/外链确认/维护开关都走“配置与策略”），避免硬编码。
- 严格规范：遵循 REST 命名规范（资源名复数、kebab-case、无动词 URL、query 与 JSON snake_case）。参考 Zalando RESTful 指南。
- 资源与成本可控：OSS 为主，不使用 MinIO（保留工具类接口）；媒体尽量直连/签名链接；AI 强限流与配额。
- 观感：少纯色，多毛玻璃/圆角；背景图由后端下发并可分区定制；公告等吸睛位置可用轮播。玻璃效果以 CSS `backdrop-filter` 为核心。
- 图标统一：使用 IconPark 图标库（后续可替换为自绘统一风格）。

---

## 2. 用户体系与访问边界

### 2.1 用户/分组（Group）(github/邮箱为唯一)
- **GUEST**（游客）：访问公开主页、公开文章、公开应用信息；不可创建内容、不可使用消耗型功能。
- **USER**（普通用户）：可使用个人配置与部分功能；AI 受配额（总 5 轮）与限流。
- **INTERVIEWER**（面试官）：隐藏注册入口 + 有效期 3 天；可访问展示区；AI 额度策略按分组配置；到期自动降级。
- **FRIEND** (友人) : 隐藏注册入口 + 管理外的所有功能
- **ADMIN**（管理员）：全站管理。

> 说明：分组的设计目标是「策略包」。比如：模块开关、额度、白名单、审核策略、是否允许导入 PNG 卡等。
>
> 分组（Group）：决定“能做什么（模块开关、配额策略、内容可见范围、导入权限、降级策略）”。
>
> 角色（Role）：一组权限点（Permission）集合，可归属于分组；用户可在多个分组中拥有多个角色。
>
> 规则：
>
> - 有效权限 = 所有分组角色的权限并集（默认）。
> - 配额/限流 = 取最严格策略（默认，保护服务器），管理员例外。
> - 模块开关 = 若任一分组禁用该模块，则对该用户禁用（同样默认更安全）；管理员可覆盖。
>
> 维护开关：管理员可“一键让除自己外所有分组禁用某模块”，前端显示“维护中”并弹出自定义原因。

### 2.2 角色（Role）与权限点（Permission）
- 角色用于更细粒度控制：例如 “可发布博客”“可审核资源”“可管理白名单”“可查看审计日志”。
- 建议权限点统一命名：`module.action`  
  例：`blog.post.create`、`media.asset.audit`、`system.whitelist.update`

### 2.3 面试官注册与降级
- 注册时不在前端暴露选项；由请求body携带 `type`（为指定的 secret）触发加入面试官分组。
- 有效期：**加入面试官分组时起算**，默认 3 天；登录后展示剩余小时/分钟。
- 到期：自动切回 USER 分组（支持管理员后台配置“降级到哪个分组”）。

### 2.4 认证与鉴权
- 使用 Sa-Token：轻量，适合你说的“个人做着玩”。
- Token 走 Header（你要求 A1 header）。
- 网关统一鉴权：auth 逻辑放在 user + gateway；网关做路由鉴权与限流，业务服务只做二次校验与资源级鉴权（防绕过）。

### 2.5 其他
- 全局限流：非管理员统一 30/min（网关级），避免服务器被打爆。
- 免费/预览模式：
  - 未提交自己的 API：总生命周期 5 轮（一问一答算 1 轮），口径已固定。
  - 预览模式仅允许“便宜模型”，并受剩余轮次与限流双重约束（你 A5 要求）。
- 面试官：走独立分组策略（可配置高于 USER 的额度，不在代码里硬编码固定值）。
- 提交自己的 API：取消“总轮数限制”，但仍保留 30/min 网关限流（你 A4 要求）。
- 对话历史：仅保存对话历史，保留 30 天；用户可自行清理。

---

## 3. 信息架构（IA）与交互设计

## 3.1 首页：学习陪伴页（默认入口）
### 3.1.1 视觉与质感约束
- 少纯色，多毛玻璃与圆角卡片；使用 `backdrop-filter` 实现背景模糊（需兼容降级）。
- 背景图来自后端配置：Home/博客列表/文章页/应用中心等可分区指定。
- 吸睛信息（公告/活动/更新）：使用轮播图（Swiper）。

### 3.1.2 侧边半透明按钮组（Floating Dock）
必须支持：
- 拖拽、吸附、位置记忆
- 增删、排序、顺序记忆
- 点击按钮触发动画（弹出菜单或打开 Home Widget）

数据保存：
- 未登录：localStorage
- 已登录：服务端 `me/preferences` 同步（仅同步轻应用清单与参数，位置/尺寸不入库）

推荐实现：
- 拖拽吸附：Interact.js（snap modifiers）
- 图标：IconPark（字节跳动图标网）（禁止 Emoji） -> 后可能变为专属png图片

## 3.2 Widgets
默认候选：
- Notes（便签）
- 计时类：Timer / Pomodoro / Stopwatch / Clock
- 计划类：Todo / Planner / Task management / Time tracking
- 轻工具/轻游戏/简单的代码

要求：
- 每个 Widget 可开关、可配置
- Home 展示区支持网格拖拽布局（建议 Gridstack）
- Widget 位置/尺寸仅保留在前端内存（刷新后按默认布局重建，不写入后端）
- 每个 widget 必须具备：
  - `widget_code`（稳定 ID）
  - `title`、`icon`、`permission_required`
  - `default_size`、`min/max_size`
  - `config_schema`（JSON schema）

## 3.3 声音系统（BGM + 环境音 + 预设 + 混音面板）
能力目标：
- Lo-fi / 环境音多轨混音（音量滑杆、静音、独奏、预设）
- 歌曲组（Playlist）与“场景预设”（比如：雨天 + 咖啡厅 + Lo-fi）
- 用户可上传音乐文件（默认 5 条，可后台改）；公共播客由管理员维护 (占用oss的有限制，但是使用)
- 用户选择播放方式(单曲/列表/随机等)

约束：
- 浏览器自动播放限制：必须通过用户交互触发播放（首次点击“播放”按钮）。

核心：浏览器端 Web Audio 混音。
 - Web Audio API 适合做多音轨、音量、滤波/混响等处理。
 - 以 `AudioContext` 为中心组织音频图（建议单例复用）。
 - 注意自动播放限制：音频播放通常需要用户交互触发（比如首次点击“播放”）。
 音源类型（可拓展为插件）：
 - `uploaded_track`：用户上传的音乐文件（OSS）
 - `public_track`：站点公共音频（播客/白噪音）
 - `api_track`：第三方 API 返回的播放链接（例如你提到的 TuneFree 体系，按其文档接入）。

## 3.4 放松/学习陪伴角色 + 背景 + 声音
### 3.4.1 角色资产（动态 CG 等）

- 公开区可轮换：但默认公开角色集只能管理员配置（你要求）。
- 用户上传 CG：
  - 有数量限制（默认 5，可后台改）
  - 可设置私密/公开
  - 管理员可查看上传者、可删除
  - 支持点赞与举报
- 是否需要登录才下发签名 URL：
  - 公共展示角色：如果你希望游客也能直接看到，会使用“公开直链”或 CDN；私密资源才走签名 URL。
  - OSS 预签名 URL：后端生成签名链接，设置短有效期（如 10 分钟），最大有效期由 OSS 机制限制（文档说明最长到 7 天）。

### 3.4.2 背景系统（分区背景）

- 背景图由后端下发，可按区块配置：
  - Home 背景
  - 博客列表背景
  - 博客文章背景
  - 应用中心背景
- 背景切换支持：
  - 公开背景池（管理员维护）
  - 用户自定义（有限制）
- 前端表现：毛玻璃卡片在背景上叠加，避免大色块。

---

## 4. 应用中心（项目聚合）

- 分类：游戏/工具/学习/其他（可后台改）

### 4.1 列表卡片字段
- 浏览数、点赞数、评论数
- 分类/标签
- 是否可添加为主页组件（pin_able）
- 是否纯前端（pure_frontend）
- 是否需要登录（login_required）

### 4.2 详情页与两种行为
- “开始使用”：进入应用（站内路由 / iframe / 外链）
- “添加主页”：将其加入 Floating Dock（同时可加入 Home 展示区）

### 4.3 外链跳转确认
- 跳转到其他域名：弹出确认，提示“后果不负责”，新标签页打开。
- 可配置白名单（例如 OSS、GitHub 免确认），你已同意。
- 安全细节：`target="_blank"` 的外链必须加 `rel="noopener"`（建议再加 `noreferrer`），防止新页面通过 `window.opener` 反制原页面

---

## 5. 博客模块（阅读为主）

### 5.1 样式参考与页面结构
- 整体信息组织参考 Halo 的阅读体验，但你实现为“内容服务 + 自定义前端”。
- 博客需要独立入口：列表/分类/标签/搜索/推荐。
- 文章页：目录、上/下篇、相关内容、举报入口（预留）。

### 5.2 编辑器
- 使用 TOAST UI Editor（Markdown + WYSIWYG 均开放）。
- Markdown 主题：后端提供主题列表与 CSS，前端缓存选择（localStorage + 服务端同步可选）。

### 5.3 安全与自由度（HTML/WYSIWYG）
- 允许更自由的 HTML，但必须进行 XSS 防护（前端预览净化 + 后端落库/展示净化）。
- iframe 允许但需域名白名单 + sandbox/CSP 限制（见安全章节）。

---

## 6. AI 陪聊模块（OpenAI 兼容 + 世界书/角色卡 + 简化 RAG）

### 6.1 调用策略
- 兼容 OpenAI 协议（可支持多家兼容服务）。
- 非管理员限流：30/min（保护服务器）。
- 无自带 API：**总共 5 轮**（用完后仅可预览或提示绑定自己的 API）。
- 有自带 API：不限制总轮数，但仍受 30/min 网关限流与服务端保护。

### 6.2 数据保留
- 仅保存对话历史：30 天；用户可手动清理。

### 6.3 世界书与角色卡
- 站内支持公开/私密/分组可见。
- 简化 RAG：世界书关键词触发注入（不先上向量库）。

### 6.4 PNG 卡与对话图片
- PNG 卡导入能力：仅允许 INTERVIEWER/ADMIN（可由管理员调整哪些分组拥有该能力）。
- 角色卡资源类型：
  - `character`（结构化 JSON，后端自有格式）
  - `character_card_png`（仅允许特定分组上传；解析后生成 `character`）
- 降级处理：
  - **仅删除“对话中产生/上传的图片资源”**（chat images）
  - 角色卡/世界书封面 PNG 图标不删除。
  - 管理员可在后台修改“降级到哪个分组”以及“删除范围”
- 额外约束（默认更保守）：图像生成类能力（若未来加入）仅对高权限分组开放。
- 业界现状与可借鉴点：
  - SillyTavern 角色卡常见做法：角色信息以 JSON 元数据嵌入 PNG 的 text chunks（关键字如 `chara`/`ccv3`），也存在 v2/v3 等规格。
  - 有现成读卡库：`@lenml/char-card-reader` 可从 PNG/JPEG/WEBP/JSON 读取角色卡元数据，便于你在前端或 Node 工具链侧快速落地解析。
  - 角色卡管理工具参考：SillyInnkeeper（本地管理器）可参考其“扫描-解析-预览-统计”设计。

### 6.5 简化版 RAG

- 不上复杂向量库的前提下，先做“世界书关键词触发”：
  - worldbook_entry：`keywords[]`、`content`、`priority`、`enabled`
  - 每轮生成前，从最近 N 条用户消息里做关键词匹配，拼接到 system/context
- 后续升级路线：
  - 增量引入向量检索（可选：pgvector/ES 向量/独立向量库）。

---

## 7. 架构与服务拆分

1. **gateway-service**
   - 统一入口、鉴权、限流、跨域、灰度/维护拦截、TraceId
2. **user-service**
   - 用户/邮箱/分组/角色/权限/策略（配额、模块开关、白名单）
   - 偏好同步（dock、widgets 清单/参数、背景等；widgets 位置/尺寸不落后端）
3. **content-service**
   - 博客、评论、点赞、浏览、举报、时间线
   - 应用中心元数据（应用条目与统计）
   - widgets 元数据与展示编排（当前阶段）
4. **media-service**
   - OSS 资源管理（上传策略、签名 URL、审核、资源统计）
   - 音乐/背景/CG/角色图片等媒体资产
5. **ai-service**
   - 会话/消息/世界书/角色卡/配额扣减/OpenAI 兼容调用

> 说明：`widgets-service` 作为后续可选拆分，当前先收敛在 `content-service`，避免早拆服务增加维护成本。

---

## 8. 数据与存储策略

### 8.1 数据存储
- MySQL：主数据与审计日志
- Redis：会话、限流、热点计数、临时状态（OAuth state、上传临时凭证等）
- OSS：所有媒体资源（按公开/私有前缀分层）

### 8.2 OSS 公开/私有分层
- 公共资源（游客必须能看到的）：公开直链（或 CDN）。
- 私有资源（用户上传音乐/私密 CG/对话图片等）：通过后端生成预签名 URL 临时访问。

### 8.3 长期备份
- MySQL：每日全量 + binlog（可选）；保留 30~90 天。
- 关键配置导出：站点配置、白名单、策略、角色权限等可导出为 JSON，并且支持导入配置。
- OSS：按生命周期策略做冷备/归档（可选）。

### 8.4 统一返回与错误

- 成功：直接返回资源 JSON 或分页对象
- 失败：建议使用 `application/problem+json` 风格（Zalando 有完整模型），至少要有：
  - `code`、`message`、`request_id`、`details`
  - 使用专门的全局的exception类和handle类来捕获异常

### 8.5 命名规范（MUST）

参考 Zalando RESTful API Guidelines：
- 资源名复数、URL 无动词、path 用 kebab-case、query 与 JSON 用 snake_case。
   并建议 API first：OpenAPI 先行。
   版本与域名建议：
-  本项目统一使用 `/api/v1/...`，不再混用 `/v1/...` 与 `/api/v1/...`。

---

## 9. 安全与合规（ASVS L1 基线）

当前选择 L1；落地原则：
- 先覆盖常见 Web 风险（XSS、CSRF、越权、注入、敏感信息泄露、滥用）。
- 强制“可止损”：限流 + 配额 + 模块开关 + 白名单。

关键点：
- HTML 内容净化（前端 + 后端双层）
- iframe 白名单 + sandbox/CSP
- 外链跳转确认 + `noopener/noreferrer`
- 日志不记录敏感信息（token、api_key、签名 URL query）

---

## 10. 可观测性与审计

### 10.1 日志

- 访问日志：网关记录（路径、状态码、耗时、userId、traceId）
- 审计日志：AOP 记录关键业务动作（改策略、禁模块、删资源、审核、导出等）
- Trace：建议使用 Micrometer Tracing（Spring Boot 3 生态）贯穿链路。

### 10.2 建议实现

- `@Audit(action="post.create", resource="posts")` 注解 + AOP 切面
- 记录字段建议：
  - `trace_id`（贯穿网关到服务）
  - `user_id`、`group_ids`
  - `http_method`、`path`
  - `resource_type`、`resource_id`
  - `result`、`error_code`
  - `cost_ms`
- 采纳 OWASP 建议：安全相关事件（登录失败、权限拒绝、限流触发、审核拒绝）必须有结构化日志。

---

## 11. 迭代路线（建议）

- Phase 0：工程骨架 + 规范门禁（P3C/格式化/CI）+ Sa-Token 鉴权 + AOP 审计
- Phase 1：学习陪伴 MVP（角色 + 声音 + dock + widgets 基础）
- Phase 2：博客阅读/搜索 + 举报预留 + 时间线
- Phase 3：应用中心（pin to home 打通）
- Phase 4：AI（会话/世界书/角色卡/总 5 轮额度 + 自带 API）
- Phase 5：UGC 资源（用户 CG 上传/审核/点赞/举报）与更多场景预设

---

## 12. 待办清单

- [x] “总共 5 轮”的轮次口径已定稿：一问一答算 1 轮。
- [ ] 邮箱域名白名单初始值：`qq.com`、`gmail.com` 等；后台可配置。
- [ ] iframe 白名单初始值：仅 `github.com` 与 OSS 相关域名（后台可加）。
- [ ] 私有资源签名 URL 默认有效期：建议 10 分钟（可配置）。

---

## 13. 当前实现对齐（基于当前仓库）

### 13.1 已完成（工程骨架与公共能力）

- 工程结构：已落地 Maven 多模块父工程，含 3 个公共库与 5 个服务。
  - 公共库：`common-core`、`common-servlet`、`common-integration`
  - 服务：`gateway-service`、`user-service`、`content-service`、`media-service`、`ai-service`
- 网关：已具备路由分发与 `X-Trace-Id` 透传。
- 公共能力：已具备统一返回、统一异常、AOP 审计、AOP 限流、请求上下文、XSS 基础净化、OAuth state / bind_ticket / captcha / refresh（Redis）与对象存储抽象。
- API 骨架：主要控制器路径已统一为 `/api/v1/**`。
- 编排：`compose.yaml` 已包含 MySQL、Redis、Nacos 与 5 个应用服务模板。

### 13.2 与原计划有出入但已明确的点

- `widgets-service` 当前未单独落地，相关后端能力先由 `content-service` 承接。
- AI 免费额度口径已统一为“总生命周期 5 轮”，不再按“每日 5 轮”解释。
- 媒体资源职责收敛到 `media-service`，避免内容服务和媒体服务职责重叠。
- 路径规范已统一到 `/api/v1/**`，不再保留混用口径。

### 13.3 当前改造状态（本轮已完成 + 仍待收尾）

1. 数据层持久化改造
- 现状：`user/content/media/ai` 四个服务已完成 `Service/ServiceImpl` 持久化替换，内存实现不再作为默认实现。
- 影响：服务重启后不再丢失核心业务数据，支持分页检索与配额统计。
- 下一步：补齐持久化相关集成测试与并发一致性验证。

2. 登录态与鉴权闭环
- 现状：已切换为统一 `/api/v1/auth/tokens`（grant 分发），并在 `user-service + gateway-service` 形成 access JWT + refresh 轮换闭环；Header 上下文用于服务内透传兼容。
- 影响：主链路具备 email_password / oauth_code / refresh_token 三种认证方式，网关按 `4xx->401`、`timeout/5xx/network->503` 统一鉴权语义。
- 下一步：补充路由规则自动校验与鉴权回归测试。

3. OSS 适配层落地
- 现状：`AliyunOssClient` 已完成 SDK 适配实现，媒体上传签名与下载签名链路可用。
- 影响：媒体资源链路从 mock 切换为真实对象存储调用。
- 下一步：推进密钥托管与轮换治理。

4. OAuth 真实登录链路
- 现状：OAuth state + code 换 token + userinfo + 本地绑定/建号 + 登录态下发已打通，并支持 GitHub + LinuxDo 双 provider。
- 影响：provider 扩展通过策略工厂统一管理，重复绑定由唯一键约束；邮箱冲突场景支持 `bind_ticket` 显式确认闭环。
- 下一步：补充异常回调与重复登录的自动化测试。

5. 审计日志入库
- 现状：审计日志已支持 DB 落库与按 `trace_id/user_id/action/time` 检索，日志实现保留为降级兜底。
- 影响：关键操作可追溯，可用于故障定位与审计追责。
- 下一步：继续接入 outbox 实时消费链路（Kafka/ELK）；当前已补 `PROCESSING` 超时回收，避免事件卡死。

> 详细改造项、涉及文件与验收标准见：`resouces/md/04_待改造计划文档_v0.1.md`

---

## 14. 技术栈清单（当前已用 + 目标定稿）

### 14.1 当前代码已使用

- 语言与框架：Java 17、Spring Boot 3.2.x
- 网关与服务治理：Spring Cloud Gateway、Spring Cloud Alibaba Nacos（discovery + config）
- 数据访问：MyBatis-Plus 依赖已引入（各服务）
- 存储与缓存：MySQL 8、Redis 7、阿里云 OSS（抽象层已落地）
- 安全与策略：AOP 权限注解、AOP 限流、AOP 审计、全局异常处理
- 构建与部署：Maven 多模块、Docker Compose

### 14.2 目标定稿（后续继续完善）

- 鉴权：Sa-Token 已接入网关与服务，后续完善自动化回归与规则治理
- 数据层：MyBatis-Plus + MySQL DDL + 索引 + 初始化脚本已落地，后续推进迁移版本化
- 对象存储：阿里云 OSS SDK 已落地，后续推进密钥治理与安全加固
- API 协议：OpenAPI 文档自动生成与联调校验
- 质量门禁：单测 + 集成测试 + CI（构建/测试/检查）

---

## 15. 中间件与内存预算（8GB 单机，开发/小流量）

> 说明：以下为工程预算值，不是压测极限值；用于本地与小规模线上部署预估。

### 15.1 中间件预算

| 组件 | 作用 | 建议内存 |
|---|---|---|
| MySQL 8 | 主数据、审计数据 | 1.2 ~ 1.6 GB |
| Redis 7 | 限流、缓存、OAuth state、bind_ticket、验证码与 refresh 会话 | 0.25 ~ 0.5 GB |
| Nacos 2.x | 注册中心 + 配置中心 | 0.5 ~ 0.8 GB |

中间件小计：约 **1.95 ~ 2.9 GB**

### 15.2 应用服务预算

| 服务 | 建议 JVM (`-Xms/-Xmx`) | 预计内存占用 |
|---|---|---|
| gateway-service | 256m / 256m | 0.30 ~ 0.40 GB |
| user-service | 384m / 384m | 0.45 ~ 0.60 GB |
| content-service | 384m / 512m | 0.50 ~ 0.70 GB |
| media-service | 384m / 512m | 0.50 ~ 0.70 GB |
| ai-service | 768m / 1024m | 0.90 ~ 1.30 GB |

应用小计：约 **2.65 ~ 3.7 GB**

### 15.3 总体预算（含中间件）

- 中间件 + 应用：约 **4.6 ~ 6.6 GB**
- 系统与 Docker 预留：建议 **1.0 ~ 1.4 GB**
- 总占用：约 **5.6 ~ 8.0 GB**

建议：
- 单机 8GB 可以跑，但应保留监控告警并限制日志膨胀。
- 若 AI 请求增多，优先扩容 `ai-service` 与 MySQL；其次再扩容 content/media。

---

## 16. 需要修改的地方（按优先级）

### P0（先做，不做会影响主链路）

- [已完成] Sa-Token 登录态闭环（login/logout/token 校验 + 网关统一鉴权）。
- [已完成] `InMemory*` 实现替换为 MyBatis-Plus 持久化 `Service/ServiceImpl`。
- [已完成] 核心表（user、group/role、preference、asset、ai_session、ai_message、audit_log、quota_usage）落地。
- [已完成] `AliyunOssClient` 真实上传与签名 URL。
- [已完成] OAuth（GitHub/LinuxDo）真实换 token 与账号绑定（含 bind_ticket 冲突确认闭环）。
- [待收尾] 端到端联调脚本与回归测试补齐。

### P1（稳定性与可维护性）

- 审计日志入库并支持查询（按 user_id / trace_id / action 检索）。
- 限流 key 从“方法级”升级为“用户/分组维度 + 方法维度”。
- 输出 OpenAPI 文档并加 CI 校验。
- 增加集成测试（网关路由、鉴权、配额、上传签名 URL）。

### P2（体验与扩展）

- widgets 细化（配置 schema、布局版本控制、多端同步冲突策略）。
- 博客检索/推荐优化与应用中心运营字段增强。
- AI 世界书触发策略与角色卡解析能力增强。
