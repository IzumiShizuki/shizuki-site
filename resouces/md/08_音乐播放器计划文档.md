# 08_音乐播放器计划文档（后端落地版）

## 1. 文档目标

本版用于锁定音乐模块后端实施边界，前端改造暂不纳入本期。

本期关键边界：
- Spotify 仅作为音乐 provider，不参与注册/登录。
- Spotify 首期只实现 `搜索 + preview_url`。
- 用户级 Spotify token 通过现有音乐 API key 接口手工绑定。
- 不新增 Spotify OAuth 回调接口，不读取 Spotify 邮箱。
- 管理员分组参数中心作为音乐策略控制层的一部分统一落地。

---

## 2. 业务规则（冻结）

1. 游客仅可播放默认歌单。
2. 登录用户默认可选歌 5 次（`music_song_pick_total`）。
3. 超额后需绑定个人 provider key 才可继续选歌。
4. 音乐上传总容量按分组配额控制（`music_upload_bytes_total`）。
5. 本地上传音频统一走 OSS 存储。
6. 第三方曲目缓存策略：朋友组及以上（`FRIEND/INTERVIEWER/ADMIN`）允许缓存到 OSS，避免重复消耗上游额度。

---

## 3. 参数中心（管理员能力）

管理员通过分组参数中心统一维护策略，音乐策略不是独立系统。

### 3.1 配额编码
- `ai_round_total`
- `music_song_pick_total`
- `music_upload_bytes_total`

### 3.2 接口
- `GET /api/v1/admin/group-quota-policies`
- `PUT /api/v1/admin/group-quota-policies/{policy_id}`
- `PUT /api/v1/admin/group-quota-policies/batch-upsert`

---

## 4. 音乐后端接口清单

### 4.1 前台接口
- `GET /api/v1/music/playlist/default`
- `GET /api/v1/music/quota/me`
- `POST /api/v1/music/picks`
- `GET /api/v1/music/providers`
- `GET /api/v1/music/key-guide`
- `GET /api/v1/music/spotify/search`
- `GET /api/v1/music/spotify/preview-url`

### 4.2 管理接口
- `GET /api/v1/admin/music/default-playlist`
- `PUT /api/v1/admin/music/default-playlist`
- `GET /api/v1/admin/music/providers`
- `PUT /api/v1/admin/music/providers/{provider}/visibility`
- `GET /api/v1/admin/music/provider-guides`
- `PUT /api/v1/admin/music/provider-guides/{provider}`

### 4.3 用户 API Key 接口
- `PUT /api/v1/me/music/api-keys/{provider}`
- `DELETE /api/v1/me/music/api-keys/{provider}`
- `GET /api/v1/me/music/api-keys/{provider}/status`

### 4.4 内部接口（服务间）
- `GET /api/v1/internal/music/api-keys/{user_id}/status?provider=spotify`
- `GET /api/v1/internal/music/api-keys/{user_id}/plaintext?provider=spotify`

---

## 5. Spotify 设计（仅音乐能力）

### 5.1 token 策略
- 优先用户级 token：用户已绑定 `provider=spotify` 时使用。
- 降级应用级 token：未绑定时用后端 `client_credentials`。

### 5.2 错误码规范
- `MUSIC_SPOTIFY_UPSTREAM_ERROR`
- `MUSIC_SPOTIFY_TOKEN_INVALID`
- `MUSIC_SPOTIFY_PREVIEW_NOT_AVAILABLE`

说明：`preview_url` 缺失时接口返回空字符串，并在响应中标记 `MUSIC_SPOTIFY_PREVIEW_NOT_AVAILABLE`，不抛异常。

---

## 6. Internal 明文接口安全规范

对 `/api/v1/internal/music/api-keys/**` 强制签名校验：
- `X-Internal-Service`
- `X-Internal-Timestamp`
- `X-Internal-Nonce`
- `X-Internal-Signature`

签名串：
`method + "\n" + path + "\n" + query + "\n" + timestamp + "\n" + nonce`

算法：
`HMAC-SHA256(shared-secret, canonical-string)`

防重放：
- 时间戳容差：300 秒（可配置）
- nonce 去重：Redis + TTL=300 秒（可配置）

---

## 7. 数据模型与迁移

### 7.1 user-service
- `USR_PROVIDER_SECRET`：存 provider 密文 key（不存邮箱）
- 基线脚本并入 V1/V2，不新增 V3+（按当前项目阶段约束）

### 7.2 media-service
- `MDA_MUSIC_PLAYLIST`
- `MDA_MUSIC_PICK_USAGE`
- `MDA_MUSIC_PROVIDER_CONFIG`
- `MDA_MUSIC_PROVIDER_GUIDE`
- `MDA_MUSIC_TRACK_CACHE`
- `MDA_MUSIC_UPLOAD_USAGE`
- `MDA_ASSET.asset_kind_code` 扩展 `AUDIO=4`

---

## 8. 配置项（Nacos 对齐）

模板文件位置：`resouces/yaml/*.yaml`，以 Nacos 实际配置为准。

新增关键项：
- `shizuki.internal.auth.shared-secret`
- `shizuki.internal.auth.clock-skew-seconds`
- `shizuki.internal.auth.nonce-ttl-seconds`
- `shizuki.music.spotify.client-id`
- `shizuki.music.spotify.client-secret`
- `shizuki.music.spotify.token-url`
- `shizuki.music.spotify.search-url`
- `shizuki.music.spotify.track-url`
- `shizuki.music.spotify.retry-count`
- `shizuki.music.spotify.retry-backoff-ms`
- `shizuki.music.spotify.retry-max-backoff-ms`
- `shizuki.music.spotify.circuit-breaker-failure-threshold`
- `shizuki.music.spotify.circuit-breaker-open-seconds`

---

## 9. 验收标准

1. USER 第 6 次选歌且无 key，返回 `MUSIC_API_KEY_REQUIRED`。
2. FRIEND 及以上不受 5 次限制影响缓存策略，可缓存第三方曲目到 OSS。
3. USER 上传累计超过 100MB 被拒绝。
4. 管理员批量 upsert 配额后即时生效。
5. internal 明文接口无签名或签名错误返回 403。
6. Spotify 搜索正常；preview 缺失时返回空字符串且可识别缺失状态。

---

## 10. 待办（前端不在本期）

1. 前端播放器切远端默认歌单优先。
2. 前端展示 Spotify preview 缺失友好提示。
3. 前端展示“剩余选歌次数 + 剩余上传容量”。
