# 第二阶段：待改造计划文档（v0.1）

> 文档定位：记录本轮改造如何落地、已经完成什么、还需要继续优化什么。
> 更新时间：2026-02-08

---

## 0. 执行顺序（已按锁定顺序推进）

本轮按以下顺序执行：
- `1 + 3`：数据层持久化 + OSS 参数化与真实实现
- `5`：审计日志入库
- `2`：Sa-Token 鉴权闭环
- `4`：OAuth 真实闭环
- `6`：限流与配额升级

---

## 1. 基础设施基线（Nacos + 目录规范）

### 1.1 已实现

- 5 个服务均新增 `bootstrap.yml`，接入 Nacos 配置中心与注册中心：
  - `services/gateway-service/src/main/resources/bootstrap.yml`
  - `services/user-service/src/main/resources/bootstrap.yml`
  - `services/content-service/src/main/resources/bootstrap.yml`
  - `services/media-service/src/main/resources/bootstrap.yml`
  - `services/ai-service/src/main/resources/bootstrap.yml`
- Nacos 地址统一默认：`192.168.88.128:8848`。
- 5 个服务 POM 均引入 `spring-cloud-starter-bootstrap`。
- 新增 `resouces/yaml` 作为 Nacos 待上传配置目录。
- 新增 `resouces/sql`，遵循“一个数据库一个 SQL 文件”的维护方式。

### 1.2 Nacos 配置文件清单

- `resouces/yaml/shizuki-common.yaml`
- `resouces/yaml/gateway-service.yaml`
- `resouces/yaml/gateway-routes.yaml`
- `resouces/yaml/user-service.yaml`
- `resouces/yaml/content-service.yaml`
- `resouces/yaml/media-service.yaml`
- `resouces/yaml/ai-service.yaml`

### 1.3 SQL 文件清单与规范

- `resouces/sql/shizuki_user.sql`
- `resouces/sql/shizuki_content.sql`
- `resouces/sql/shizuki_media.sql`
- `resouces/sql/shizuki_ai.sql`

已执行规范：
- 每个文件头有数据库说明和 `last_modified_at`。
- 每个增量块有 `-- modified_at: yyyy-MM-dd HH:mm:ss`。
- 每个增量块有 `-- change: ...` 用途说明。
- DDL 大量使用 `IF NOT EXISTS` 保持可重复执行。
- 核心表与字段已补齐 `COMMENT` 注释，便于入库与后续维护。

### 1.4 仍待优化

- 目前 SQL 仍是手工增量，建议下一轮接入 Flyway/Liquibase 做版本化迁移。

---

## 2. 改造项完成情况

## 2.1 问题 1：数据层持久化（已完成）

### 已实现

- user-service：
  - 内存实现替换为 `UserServiceImpl`：
    - `services/user-service/src/main/java/io/github/shizuki/site/user/service/impl/UserServiceImpl.java`
  - 新增实体与 Mapper：
    - `UserAccountEntity/UserPreferenceEntity/OAuthLoginEntity/OAuthBindingEntity/GroupQuotaPolicyEntity`
    - `UserAccountMapper/UserPreferenceMapper/OAuthLoginMapper/OAuthBindingMapper/GroupQuotaPolicyMapper`
- content-service：
  - 内存实现替换为 `ContentServiceImpl`。
  - 新增 `PostEntity/AppEntity/ContentReportEntity` 及对应 Mapper。
- media-service：
  - 内存实现替换为 `MediaServiceImpl`。
  - 新增 `MediaAssetEntity/MediaAssetReportEntity` 及对应 Mapper。
- ai-service：
  - 内存实现替换为 `AiServiceImpl`。
  - 新增 `AiSessionEntity/AiMessageEntity/AiQuotaUsageEntity/AiCharacterEntity` 及对应 Mapper。
- 4 个服务 `application.yml` 默认库已切换为分库：
  - `shizuki_user/shizuki_content/shizuki_media/shizuki_ai`。

### 仍待优化

- 当前仓库尚未补足完整集成测试（重启后数据一致性、事务边界、并发写入场景）。

---

## 2.2 问题 3：OSS 参数化与真实实现（已完成）

### 已实现

- `common-integration` 新增 OSS 参数对象：
  - `libs/common-integration/src/main/java/io/github/shizuki/common/storage/config/OssProperties.java`
- `AliyunOssClient` 已改为真实实现，支持：
  - 上传 `putObject`
  - 删除 `deleteObject`
  - 下载签名 URL `generateGetUrl`
  - 上传签名 URL `generatePutUrl`
- `media-service` 已接入真实对象存储客户端，不再使用 mock URL。
- `resouces/yaml/media-service.yaml` 写入 OSS 所需参数：`endpoint/bucket/sign-expire/max-upload-size` 等。

### 仍待优化

- OSS 密钥当前仍通过配置项注入，建议下一轮迁移到密钥管理系统（KMS/Vault）。

---

## 2.3 问题 5：审计日志入库（已完成）

### 已实现

- 每个分库都新增：
  - `audit_log`
  - `audit_event_outbox`
- 保留原 `AuditLogAspect` 采集能力，新增 DB 落库实现：
  - `libs/common-servlet/src/main/java/io/github/shizuki/common/audit/service/JdbcAuditLogService.java`
- DB 落库失败自动降级到日志实现：
  - `LoggingAuditLogService`
- 新增审计检索接口（支持 trace_id/user_id/action/time）：
  - `libs/common-servlet/src/main/java/io/github/shizuki/common/audit/controller/AuditLogQueryController.java`

### 仍待优化

- outbox 当前只做“结构预留 + 持久化”，未接实时消费链路（Kafka/ELK）。

---

## 2.4 问题 2：Sa-Token 鉴权闭环（已完成）

### 已实现

- 认证头统一：`Authorization: Bearer <token>`。
- user-service 新增登录闭环接口：
  - `POST /api/v1/auth/login`
  - `POST /api/v1/auth/logout`
  - `GET /api/v1/auth/introspect`
- gateway-service 新增统一鉴权过滤器：
  - `services/gateway-service/src/main/java/io/github/shizuki/site/gateway/filter/AuthGatewayFilter.java`
- 网关支持：
  - 白名单路径直接放行
  - guest 路径注入 GUEST 上下文
  - 受保护路径走 introspect 校验
  - 成功后透传 `X-User-Id/X-User-Groups/X-User-Permissions`

### 仍待优化

- 网关鉴权目前按路径匹配规则管理，建议下一轮补充“路由配置中心化 + 自动校验脚本”。

---

## 2.5 问题 4：OAuth 真实闭环（已完成）

### 已实现

- 保留原接口形态：`/api/v1/oauth-logins/**`。
- `UserServiceImpl` 完成真实 OAuth 链路：
  - create login
  - state 校验
  - code 换 token
  - 拉 GitHub 用户信息
  - 本地账号绑定/创建
  - Sa-Token 登录态下发
- 防重复绑定通过 `(provider, provider_user_id)` 唯一键保障。
- 失败场景记录到 `oauth_login.status/error_message`。

### 仍待优化

- 建议补充 GitHub OAuth 全链路自动化测试（含 state 过期、重复登录、异常回调）。

---

## 2.6 问题 6：限流与配额升级（已完成）

### 已实现

- `RateLimitAspect` 键升级为用户/分组维度：
  - `rate-limit:<base>:u:<userId|guest>:g:<groups>`
- AI 配额改为数据库持久化计数：
  - `ai_quota_usage`
- AI 配额支持按用户分组动态解析：
  - ai-service 通过 `UserQuotaClient` 调 user-service 内部接口解析配额
  - user-service 通过 `group_quota_policy` 持久化配置返回结果
- 超限返回统一 ProblemDetail 结构，并携带 `remaining`：
  - 限流超限：`remaining=0`、`limit_key`、`window_seconds`
  - AI 配额耗尽：`remaining=0`、`quota_code`、`total`、`used`

### 仍待优化

- 限流当前为 Redis 优先 + 本地降级，下一轮建议补充分布式一致性压测与告警阈值。

---

## 3. 关键配置与脚本如何使用

## 3.1 SQL 初始化顺序

建议先执行：
1. `resouces/sql/shizuki_user.sql`
2. `resouces/sql/shizuki_content.sql`
3. `resouces/sql/shizuki_media.sql`
4. `resouces/sql/shizuki_ai.sql`

执行原则：
- 每次新增 SQL 直接追加到文件尾部。
- 必须写 `modified_at` 与 `change` 注释。

## 3.2 Nacos 导入建议

建议 Data ID 与 Group：
1. `shizuki-common.yaml` / `DEFAULT_GROUP`
2. `gateway-service.yaml` / `DEFAULT_GROUP`
3. `gateway-routes.yaml` / `DEFAULT_GROUP`
4. `user-service.yaml` / `DEFAULT_GROUP`
5. `content-service.yaml` / `DEFAULT_GROUP`
6. `media-service.yaml` / `DEFAULT_GROUP`
7. `ai-service.yaml` / `DEFAULT_GROUP`

服务默认从 `192.168.88.128:8848` 拉取。

---

## 4. 本轮验收结果

### 4.1 已验证

- 多模块编译通过：
  - 执行命令：`mvn -DskipTests compile -T 1C`
  - 结果：9 个模块 `BUILD SUCCESS`
- 目录与配置基线已落地：`resouces/yaml`、`resouces/sql`、`bootstrap.yml`。
- 持久化、鉴权、OAuth、OSS、审计、配额六项改造代码已接入主干。

### 4.2 未完成验证

- 端到端联调（依赖 Nacos/MySQL/Redis/OSS/GitHub OAuth 外部环境）。
- 自动化集成测试与压测报告。

---

## 5. 下一步待改进事项（建议）

1. 接入 Flyway/Liquibase 统一 SQL 迁移版本管理。
2. 增加 CI 校验：SQL 增量块必须包含 `modified_at` 和 `change` 注释。
3. 接入密钥托管（Nacos 加密/KMS/Vault），移除明文密钥默认值。
4. 补齐鉴权、OAuth、配额、审计检索的集成测试。
5. 审计 outbox 接统一消费链路（Kafka/ELK）并补消费失败重试机制。

---

## 6. 下一步动工计划（建议）

1. 先动工测试与联调：补齐 `gateway/user/ai/media` 的集成测试，覆盖登录、OAuth、配额扣减、上传签名 URL。
2. 再动工数据治理：引入 Flyway/Liquibase，将 `resouces/sql/*.sql` 按版本迁移脚本拆分并接入启动流程。
3. 最后动工审计链路：基于现有 `audit_event_outbox` 接入消费任务（先定时轮询，再演进 Kafka/ELK）。
