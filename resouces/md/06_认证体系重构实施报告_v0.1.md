# 认证体系重构实施报告 v0.1

- 文档日期：2026-02-11
- 适用仓库：`shizuki-site`
- 作者：Codex（基于当前代码状态自动归档）

---

## 1. 实施目标与范围

本次实施聚焦两条主线：

1. **认证体系重构**（策略模式 + 工厂模式）
- 统一登录入口（grant_type）
- 支持 `github/linuxdo` OAuth2 授权码登录
- 支持邮箱注册 + 密码登录
- 支持图形验证码 + 邮箱验证码
- 返回 `access token (JWT)` + `refresh token`
- 支持 refresh 单次轮换

2. **韧性与网关行为收口**
- guest 路径坏 token 默认降级游客，支持切换严格拒绝
- introspect 错误分层：`4xx -> 401`，`timeout/5xx/network -> 503`
- 统一结构化日志字段：`reason`、`upstream_status`
- `UserQuotaClient` 接入统一重试组件，移除手写 sleep 退避

---

## 2. 总体架构决策

### 2.1 认证分发层

- 采用 `AuthGrantStrategy + AuthGrantStrategyFactory`：
  - `EMAIL_PASSWORD`
  - `OAUTH_CODE`
  - `REFRESH_TOKEN`
- 控制器只负责接收请求，业务编排下沉到 `AuthServiceImpl` 与 `AuthFlowService`。

### 2.2 OAuth 提供方层

- 采用 `OAuthProviderStrategy + OAuthProviderStrategyFactory`：
  - `GitHubOAuthProviderStrategy`
  - `LinuxDoOAuthProviderStrategy`
- 提供方公共逻辑（构建授权 URL、换 token、拉用户信息、异常分层、重试）下沉至 `AbstractOAuthProviderStrategy`。

### 2.3 Token 生命周期

- Access token：Sa-Token JWT 模式签发。
- Refresh token：随机高熵字符串，服务端 Redis 存 `jti + token hash`。
- 轮换策略：`refresh_rotate=true` 时，旧 refresh 立即失效并签发新 refresh。

### 2.4 验证码与反滥用

- 图形验证码（SVG 算术题）用于邮箱验证码发送前置校验。
- 邮箱验证码在 Redis 中仅存摘要，支持冷却窗口与失败次数上限。
- 发送接口叠加 `@RateLimit` 进行网关/服务双层限频。

### 2.5 统一韧性组件

- 复用 `common-core` 新增 `SpringRetryExecutor`。
- 重试策略：指数退避 + jitter + 最大退避上限。
- 仅对明确标注的瞬时异常类型重试。

---

## 3. 登录流程（Mermaid）

```mermaid
flowchart TD
    A[Client 调用 POST /api/v1/auth/tokens\ngrant_type] --> B{grant_type}

    B -->|email_password| C[校验 email/password]
    C --> C1{账号存在且密码匹配?}
    C1 -->|否| E401[返回 401 UNAUTHORIZED]
    C1 -->|是| T[签发 Access JWT + Refresh Token]

    B -->|oauth_code| O0[校验 oauth_login_id/code/state]
    O0 --> O1[OAuthProviderStrategyFactory 选 provider]
    O1 --> O2[exchangeCode: code->token->userinfo]
    O2 --> O3{provider_user_id 是否已绑定?}
    O3 -->|是| T
    O3 -->|否| O4{第三方邮箱是否与现有用户冲突?}
    O4 -->|是| BR[返回 BIND_REQUIRED + bind_ticket]
    O4 -->|否| O5[创建账号 + OAuth绑定]
    O5 --> T

    B -->|refresh_token| R0[校验 refresh_token]
    R0 --> R1{refresh_rotate 开启?}
    R1 -->|是| R2[rotate: 旧refresh失效 + 新refresh签发]
    R1 -->|否| R3[复用原refresh]
    R2 --> T2[签发新 Access JWT]
    R3 --> T2

    T --> OK[返回 TOKEN_ISSUED]
    T2 --> OK

    subgraph OAuth前置入口
      OA[POST /api/v1/auth/oauth/authorizations\nscene=login|bind] --> OB[生成 oauth_login_id + state + authorize_url]
    end

    subgraph 邮箱注册前置入口
      V1[GET /api/v1/auth/captchas/image] --> V2[POST /api/v1/auth/verifications/email/send]
      V2 --> V3[POST /api/v1/auth/register/email]
      V3 --> T
    end
```

---

## 4. 关键接口落地清单

### 4.1 认证主接口

- `POST /api/v1/auth/tokens`
- `POST /api/v1/auth/logout`
- `GET /api/v1/auth/introspect`

实现位置：
- `services/user-service/src/main/java/io/github/shizuki/site/user/controller/AuthController.java`

### 4.2 注册与验证码

- `GET /api/v1/auth/captchas/image`
- `POST /api/v1/auth/verifications/email/send`
- `POST /api/v1/auth/register/email`

实现位置：
- `services/user-service/src/main/java/io/github/shizuki/site/user/controller/AuthVerificationController.java`
- `services/user-service/src/main/java/io/github/shizuki/site/user/controller/AuthRegistrationController.java`

### 4.3 OAuth 授权与绑定

- `POST /api/v1/auth/oauth/authorizations`
- `POST /api/v1/me/bindings/email`
- `POST /api/v1/me/bindings/oauth`

实现位置：
- `services/user-service/src/main/java/io/github/shizuki/site/user/controller/AuthVerificationController.java`
- `services/user-service/src/main/java/io/github/shizuki/site/user/controller/AuthBindingController.java`

### 4.4 旧接口处理

- 下线旧 `OAuthLoginController`
- 登录入口由旧 `/auth/login` 切换到统一 `/auth/tokens`

---

## 5. 数据与配置变更

### 5.1 DB 迁移

新增迁移：
- `services/user-service/src/main/resources/db/migration/V3__auth_upgrade.sql`

变更内容：
- `USR_ACCOUNT.email_verified_flag`
- `USR_ACCOUNT` 唯一约束 `AK_USR_ACCOUNT_2 (email_text)`
- `OAU_LOGIN.login_scene`
- `OAU_LOGIN.initiator_user_id`
- 索引 `IX_OAU_LOGIN_2 (provider_type, login_scene, create_time)`

同步 SQL 文档：
- `resouces/sql/shizuki_user.sql`

### 5.2 Redis Key 约定（已落地）

- `auth:captcha:image:{captcha_id}`
- `auth:verify:email:{purpose}:{email}`
- `auth:verify:cooldown:{purpose}:{email}`
- `auth:verify:attempt:{purpose}:{email}`
- `auth:refresh:{refresh_jti}`
- `auth:refresh:user:{user_id}`
- `auth:bind-ticket:{ticket}`

### 5.3 配置新增

- `services/user-service/src/main/resources/application.yml`
  - `shizuki.auth.jwt.*`
  - `shizuki.auth.captcha.*`
  - `shizuki.auth.verify.*`
  - `shizuki.auth.bind.*`
  - `spring.mail.*`
  - `shizuki.oauth.providers.github.*`
  - `shizuki.oauth.providers.linuxdo.*`

- `services/gateway-service/src/main/resources/application.yml`
  - `shizuki.gateway.auth.guest-invalid-token-policy`
  - `public-paths` 切换到新 auth 路径
  - `guest-paths` 增加 `/api/v1/ai-sessions/**`

- `services/ai-service/src/main/resources/application.yml`
  - `quota-resolve-connect-timeout-ms`
  - `quota-resolve-retry-max-backoff-ms`

---

## 6. 韧性与错误语义实现细节

### 6.1 网关 introspect 分层

实现文件：
- `services/gateway-service/src/main/java/io/github/shizuki/site/gateway/filter/AuthGatewayFilter.java`

行为：
- `onStatus(4xx)` -> `TokenRejectedException` -> HTTP `401`
- `onStatus(5xx)` -> `TransientIntrospectException` -> HTTP `503`
- `timeout/network/invalid_payload` -> `TransientIntrospectException` -> HTTP `503`
- guest 路径 `policy=downgrade` 且 token rejected：覆盖为 `GUEST`

结构化日志：
- `reason`
- `upstream_status`
- `path`
- `guest_path`
- `policy`

### 6.2 配额客户端重试边界

实现文件：
- `services/ai-service/src/main/java/io/github/shizuki/site/ai/client/UserQuotaClient.java`

行为：
- `4xx`：不重试，直接 fallback
- `5xx/network`：进入统一重试
- 重试耗尽：fallback

### 6.3 OAuth 与邮件发送重试

- OAuth provider 调用接入统一 `SpringRetryExecutor`
- Mail 发送对瞬时异常重试，认证类错误不重试

---

## 7. 测试与验证

### 7.1 执行命令

```bash
mvn -pl libs/common-core,libs/common-integration,services/ai-service,services/gateway-service,services/user-service -am test -DskipITs -Dtest=SpringRetryExecutorTest,OAuthProviderStrategyFactoryTest,UserQuotaClientTest,AuthGatewayFilterTest,AuthControllerIntegrationTest,AuthVerificationControllerIntegrationTest,AuthRegistrationControllerIntegrationTest,AuthBindingControllerIntegrationTest,AuthGrantStrategyFactoryTest,ImageCaptchaServiceTest -Dsurefire.failIfNoSpecifiedTests=false
```

### 7.2 结果

- `BUILD SUCCESS`
- 通过摘要：
  - `common-core`: 3 tests
  - `common-integration`: 3 tests
  - `gateway-service`: 5 tests
  - `user-service`: 20 tests
  - `ai-service`: 3 tests

### 7.3 覆盖的关键行为

- guest 坏 token 降级与 reject 策略切换
- introspect timeout/5xx -> 503
- 网关日志包含 `reason/upstream_status`
- 配额 4xx 不重试，5xx 可重试并支持恢复
- grant 工厂路由
- 验证码一次性消费
- 新 auth 控制器路由与返回结构

---

## 8. 如何完成（执行路径）

1. 先完成可复用基础设施：`SpringRetryExecutor` 与 `RetrySpec`。
2. 在网关与配额客户端接入统一重试，先锁定错误语义。
3. 抽象 OAuth provider 层，完成 GitHub/LinuxDo provider 实现。
4. 重构 user-service 认证入口为 grant 策略工厂。
5. 补齐验证码、邮箱注册、refresh 轮换、绑定流程。
6. 增加 Flyway 与 SQL 文档同步。
7. 追加最小必要测试并跑全链路定向测试。

---

## 9. 已知差异与后续建议

### 9.1 已知差异

- `bind_ticket` 已生成并返回（`BIND_REQUIRED`），但目前尚无独立“消费 bind_ticket 确认绑定”的专用接口，当前绑定主要通过登录态 `/api/v1/me/bindings/oauth`。

### 9.2 建议下一步

1. 增加 `bind_ticket` 显式确认接口，完成冲突绑定闭环。
2. 增加端到端集成测试（MySQL/Redis/OAuth mock/SMTP mock）。
3. 上线前补充监控指标：token 发放量、refresh 轮换失败率、验证码发送失败率、OAuth 上游错误率。

---

## 10. 关键文件索引

### 10.1 认证重构核心
- `services/user-service/src/main/java/io/github/shizuki/site/user/controller/AuthController.java`
- `services/user-service/src/main/java/io/github/shizuki/site/user/controller/AuthVerificationController.java`
- `services/user-service/src/main/java/io/github/shizuki/site/user/controller/AuthRegistrationController.java`
- `services/user-service/src/main/java/io/github/shizuki/site/user/controller/AuthBindingController.java`
- `services/user-service/src/main/java/io/github/shizuki/site/user/service/impl/AuthServiceImpl.java`
- `services/user-service/src/main/java/io/github/shizuki/site/user/service/auth/AuthFlowService.java`
- `services/user-service/src/main/java/io/github/shizuki/site/user/service/auth/AuthTokenIssuer.java`
- `services/user-service/src/main/java/io/github/shizuki/site/user/service/auth/RefreshTokenService.java`

### 10.2 OAuth Provider 抽象
- `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/strategy/OAuthProviderStrategy.java`
- `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/strategy/OAuthProviderStrategyFactory.java`
- `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/strategy/AbstractOAuthProviderStrategy.java`
- `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/strategy/GitHubOAuthProviderStrategy.java`
- `libs/common-integration/src/main/java/io/github/shizuki/common/oauth/strategy/LinuxDoOAuthProviderStrategy.java`

### 10.3 韧性收口核心
- `libs/common-core/src/main/java/io/github/shizuki/common/core/resilience/RetrySpec.java`
- `libs/common-core/src/main/java/io/github/shizuki/common/core/resilience/SpringRetryExecutor.java`
- `services/gateway-service/src/main/java/io/github/shizuki/site/gateway/filter/AuthGatewayFilter.java`
- `services/ai-service/src/main/java/io/github/shizuki/site/ai/client/UserQuotaClient.java`

---

> 备注：本文档用于“现阶段基础骨架完成态”归档，便于后续接入真实业务逻辑时快速定位边界与扩展点。
